#!/usr/bin/env bash
set -euo pipefail

PATTERN='(ANTHROPIC_API_KEY|OPENAI_API_KEY|TELEGRAM.*TOKEN|botToken|CLAWDBOT_GATEWAY_TOKEN|api_key|secret|password|-----BEGIN (RSA|OPENSSH|EC) PRIVATE KEY-----)'

files="$(git diff --cached --name-only --diff-filter=AM || true)"
[[ -z "${files}" ]] && exit 0

hit=0
while IFS= read -r f; do
  [[ -z "$f" ]] && continue

  # avoid self-trigger: the hook definition itself contains the pattern
  if [[ "$f" == "scripts/pre-commit" ]]; then
    continue
  fi

  if git show ":$f" 2>/dev/null | grep -nE "$PATTERN" >/dev/null; then
    echo "[BLOCKED] Possible secret detected in staged file: $f" >&2
    git show ":$f" | grep -nE "$PATTERN" | head -n 20 >&2 || true
    hit=1
  fi
done <<< "$files"

if [[ "$hit" -eq 1 ]]; then
  echo "Commit aborted. Remove secrets or move them to systemd credentials / external files." >&2
  exit 1
fi
