#!/usr/bin/env node
/**
 * Daily Brief Pipeline
 * å®Œæ•´æµç¨‹ï¼šæœé›†æ–°è â†’ AI åˆ†æ â†’ ç”Ÿæˆ Daily Brief
 */
const { execSync } = require("child_process");

const NewsCollector = require('./news-collector');
const NewsAnalyzer = require('./news-analyzer');
const DailyBriefGenerator = require('./daily-brief-generator');

async function main() {
  console.log('ğŸš€ å•Ÿå‹• Daily Brief Pipeline...\n');

  try {
    // Step 1: æœé›†æ–°è
    console.log('ğŸ“¡ Step 1: æœé›†æ–°è');
    const collector = new NewsCollector({
      symbols: ['TSMC', '^TWII', '^GSPC', 'NVDA', 'AAPL', 'MSFT'],
      keywords: ['å°ç©é›»', 'è¯ç™¼ç§‘', 'AI', 'Fed', 'é™æ¯', 'éè¾²', 'å°è‚¡', 'ç¾è‚¡']
    });
    
    const news = await collector.collectAll();
    
    if (news.length === 0) {
      console.log('âš ï¸  æ²’æœ‰æœé›†åˆ°æ–°è');
      process.exit(1);
    }
    
    await collector.saveToFile(news);
    console.log(`âœ… æœé›†å®Œæˆï¼š${news.length} å‰‡æ–°è\n`);
    
// Step 1.5: ç”¢ç”Ÿ Digestï¼ˆç”± my-project æä¾›ï¼‰
    console.log('ğŸ§  Step 1.5: åŸ·è¡Œ Digest CLIï¼ˆæ‘˜è¦æ–°èï¼‰');
    try {
      execSync(
        `DIGEST_OUTPUT_DIR=/home/clawbot/clawd/agents/market-digest/data/digest/output ` +
        `DIGEST_EXAMPLES_DIR=/home/clawbot/clawd/agents/market-digest/data/digest/examples ` +
        `node /home/clawbot/projects/my-project/src/main/js/index.js digest run`,
        { stdio: 'inherit', shell: '/bin/bash' }
      );
      console.log('âœ… Digest å®Œæˆ\n');
    } catch (e) {
      console.log('âš ï¸ Digest å¤±æ•—ï¼ˆç•¥éï¼Œä¸å½±éŸ¿ pipelineï¼‰\n');
    }
    // Step 2: AI åˆ†æ
    console.log('ğŸ”¬ Step 2: AI åˆ†ææ–°è');
    const analyzer = new NewsAnalyzer();
    const analyzed = await analyzer.analyzeAll(news);
    const important = analyzer.filterByImportance(analyzed, 7);
    
    console.log(`âœ… åˆ†æå®Œæˆï¼š${important.length} å‰‡é‡è¦æ–°èï¼ˆimportance >= 7ï¼‰\n`);
    
    await analyzer.saveToFile(important);

    // Step 3: ç”Ÿæˆ Daily Brief
    console.log('ğŸ“Š Step 3: ç”Ÿæˆ Daily Brief');
    const generator = new DailyBriefGenerator();
    const brief = await generator.generate();
    
    if (brief) {
      await generator.saveToFile(brief);
      console.log('âœ… Daily Brief ç”Ÿæˆå®Œæˆï¼\n');
      
      // é¡¯ç¤ºé è¦½
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log('ğŸ“„ Daily Brief é è¦½ï¼š');
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
      console.log(brief.substring(0, 1000) + '...\n');
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
      
      const date = new Date().toISOString().split('T')[0];
      console.log(`ğŸ“‚ å®Œæ•´å ±å‘Šä½ç½®ï¼š`);
      console.log(`   ~/clawd/agents/market-digest/data/daily-brief/${date}.txt\n`);
    } else {
      console.log('âŒ Daily Brief ç”Ÿæˆå¤±æ•—');
      process.exit(1);
    }

    console.log('ğŸ‰ Pipeline åŸ·è¡Œå®Œæˆï¼');
    
  } catch (error) {
    console.error('âŒ Pipeline åŸ·è¡Œå¤±æ•—:', error);
    process.exit(1);
  }
}

if (require.main === module) {
  main();
}

module.exports = main;
