#!/usr/bin/env node
/**
 * Market Digest Daily Brief Generator
 * ç”Ÿæˆ Daily Market Brief æ ¼å¼å ±å‘Š
 */

const fs = require('fs').promises;
const path = require('path');
const { exec } = require('child_process');
const { promisify } = require('util');

const execAsync = promisify(exec);

class DailyBriefGenerator {
  constructor(config = {}) {
    this.config = config;
    this.date = config.date || new Date().toISOString().split('T')[0];
  }

  /**
   * ç”Ÿæˆå®Œæ•´ Daily Brief
   */
  async generate() {
    console.log(`ğŸ“Š ç”Ÿæˆ Daily Market Brief (${this.date})...`);

    // è¼‰å…¥è³‡æ–™
    const analyzedNews = await this.loadAnalyzedNews();
    const marketData = await this.loadMarketData();
    const watchlist = await this.loadWatchlist();

    if (analyzedNews.length === 0) {
      console.log('âš ï¸  æ²’æœ‰åˆ†æéçš„æ–°èï¼Œç„¡æ³•ç”Ÿæˆ Daily Brief');
      return null;
    }

    // ç”Ÿæˆå„å€‹ sections
    const sections = {
      dailySnapshot: await this.generateDailySnapshot(analyzedNews, marketData),
      marketRegime: await this.generateMarketRegime(analyzedNews, marketData),
      macroPolicy: await this.generateMacroPolicy(analyzedNews, marketData),
      geopolitics: await this.generateGeopolitics(analyzedNews),
      structuralTheme: await this.generateStructuralTheme(analyzedNews),
      equityMarket: await this.generateEquityMarket(analyzedNews),
      crossAsset: await this.generateCrossAsset(analyzedNews, marketData),
      taiwanMarket: await this.generateTaiwanMarket(analyzedNews, marketData),
      watchlistFocus: await this.generateWatchlistFocus(analyzedNews, watchlist),
      eventCalendar: await this.generateEventCalendar(analyzedNews)
    };

    // çµ„è£å®Œæ•´å ±å‘Š
    const brief = this.assembleBrief(sections);
    
    console.log('âœ… Daily Brief ç”Ÿæˆå®Œæˆï¼');
    return brief;
  }

  /**
   * è¼‰å…¥åˆ†æéçš„æ–°è
   */
  async loadAnalyzedNews() {
    const filePath = path.join(__dirname, 'data/news-analyzed', `${this.date}.json`);
    try {
      const content = await fs.readFile(filePath, 'utf8');
      const data = JSON.parse(content);
      return data.news || [];
    } catch (error) {
      console.error(`[Brief Generator] è®€å–åˆ†ææ–°èå¤±æ•—:`, error.message);
      return [];
    }
  }

  /**
   * è¼‰å…¥å¸‚å ´æ•¸æ“š
   */
  async loadMarketData() {
    try {
      // è¼‰å…¥ config
      const configPath = path.join(__dirname, 'config.json');
      const config = JSON.parse(await fs.readFile(configPath, 'utf8'));
      
      // ä½¿ç”¨ç¾æœ‰çš„ fetcher
      const MarketDataFetcher = require('./backend/fetcher');
      const fetcher = new MarketDataFetcher(config);
      
      const data = await fetcher.fetchMarketData();
      
      // è½‰æ›ç‚ºçµ±ä¸€æ ¼å¼
      return {
        twii: {
          value: data.tw_stock?.close || 32195.359,
          change: data.tw_stock?.changePercent || -1.85
        },
        sp500: {
          value: data.us_stock?.gspc?.close || 6917.81,
          change: data.us_stock?.gspc?.changePercent || -0.87
        },
        usd_twd: {
          value: data.fx?.close || 31.58,
          change: data.fx?.changePercent || 1.5
        },
        us10y: { value: 4.23, change: -0.05 }, // TODO: æ•´åˆå‚µåˆ¸æ•¸æ“š
        dxy: { value: 96.2, change: -0.5 },     // TODO: æ•´åˆç¾å…ƒæŒ‡æ•¸
        vix: { value: 17.2, change: 1.1 }       // TODO: æ•´åˆ VIX
      };
    } catch (error) {
      console.error('[Market Data] è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼:', error.message);
      // å›å‚³é è¨­å€¼
      return {
        twii: { value: 32195.359, change: -1.85 },
        sp500: { value: 6917.81, change: -0.87 },
        usd_twd: { value: 31.58, change: 1.5 },
        us10y: { value: 4.23, change: -0.05 },
        dxy: { value: 96.2, change: -0.5 },
        vix: { value: 17.2, change: 1.1 }
      };
    }
  }

  /**
   * è¼‰å…¥ watchlist
   */
  async loadWatchlist() {
    const filePath = path.join(__dirname, 'data/watchlist.json');
    try {
      const content = await fs.readFile(filePath, 'utf8');
      const data = JSON.parse(content);
      // watchlist æ ¼å¼ï¼š{ stocks: [{ code, name }, ...] }
      return data.stocks || [];
    } catch (error) {
      return [];
    }
  }

  /**
   * ç”Ÿæˆ Daily Snapshot
   */
  async generateDailySnapshot(news, marketData) {
    // æ ¹æ“šæ–°èèˆ‡å¸‚å ´æ•¸æ“šï¼Œæç…‰ 3-5 å€‹é—œéµé‡é»
    const topNews = news.slice(0, 10);
    const snapshot = [];
    
    // æ ¹æ“šå¸‚å ´æ•¸æ“šç”Ÿæˆç¬¬ä¸€æ¢
    const twChange = marketData.twii.change;
    const spChange = marketData.sp500.change;
    
    if (Math.abs(twChange) > 1) {
      if (twChange < 0) {
        snapshot.push(`å°è‚¡é«˜æª”éœ‡ç›ªï¼ŒæŒ‡æ•¸å›æª” ${Math.abs(twChange).toFixed(2)}%`);
      } else {
        snapshot.push(`å°è‚¡çºŒå¼·ï¼ŒæŒ‡æ•¸ä¸Šæ¼² ${twChange.toFixed(2)}%`);
      }
    } else {
      snapshot.push('å°è‚¡ç›¤æ•´ï¼Œç­‰å¾…æ–¹å‘æ˜æœ—');
    }
    
    // å¾æ–°èä¸­æå–é—œéµäº‹ä»¶
    const macroNews = topNews.filter(n => n.analysis.category === 'ç¸½ç¶“');
    if (macroNews.length > 0) {
      const firstMacro = macroNews[0];
      const shortTitle = firstMacro.title.substring(0, 30);
      snapshot.push(`${shortTitle}ï¼Œ${firstMacro.analysis.marketImplication.substring(0, 20)}`);
    }
    
    // ç”¢æ¥­è¶¨å‹¢
    const industryNews = topNews.filter(n => n.analysis.category === 'ç”¢æ¥­' || n.analysis.category === 'å°è‚¡');
    if (industryNews.length > 0) {
      const industries = industryNews.slice(0, 2).map(n => {
        if (n.title.includes('AI') || n.title.includes('å°ç©é›»')) return 'AI æ—ç¾¤';
        if (n.title.includes('è¨˜æ†¶é«”')) return 'è¨˜æ†¶é«”æ—ç¾¤';
        if (n.title.includes('è˜‹æœ')) return 'è˜‹æœä¾›æ‡‰éˆ';
        return 'ç§‘æŠ€è‚¡';
      });
      snapshot.push(`${industries[0]}æŒçºŒå—é—œæ³¨`);
    }
    
    // åŒ¯ç‡
    if (Math.abs(marketData.usd_twd.change) > 0.5) {
      if (marketData.usd_twd.change > 0) {
        snapshot.push(`å°å¹£è²¶å€¼å£“åŠ›ï¼Œé—œæ³¨ ${marketData.usd_twd.value.toFixed(2)} é—œå¡`);
      } else {
        snapshot.push(`å°å¹£è½‰å¼·ï¼Œç¾å…ƒå›è½`);
      }
    }
    
    return snapshot.slice(0, 5);
  }

  /**
   * ç”Ÿæˆ Market Regime
   */
  async generateMarketRegime(news, marketData) {
    // åŸºæ–¼å¸‚å ´æ•¸æ“šèˆ‡æ–°èåˆ¤æ–· Regime
    const vixChange = marketData.vix.change;
    const twChange = marketData.twii.change;
    const spChange = marketData.sp500.change;
    
    let state = '';
    let flow = '';
    let implication = '';
    
    // åˆ¤æ–· Risk-on / Risk-off
    if (vixChange > 1) {
      state = 'Risk-off æƒ…ç·’å‡æº«ï¼Œå¸‚å ´é¿éšªéœ€æ±‚å¢åŠ ';
    } else if (vixChange < -1) {
      state = 'Risk-on ä¸»å°ï¼Œå¸‚å ´é¢¨éšªåå¥½å›å‡';
    } else {
      state = 'Risk-on èˆ‡ Risk-off ä¸¦å­˜';
    }
    
    // åˆ¤æ–·è³‡é‡‘æµå‘
    if (twChange > 0 && spChange > 0) {
      flow = 'å…¨çƒè‚¡å¸‚åŒæ­¥èµ°å¼·ï¼Œè³‡é‡‘åå¥½é¢¨éšªè³‡ç”¢';
    } else if (twChange < 0 && spChange < 0) {
      flow = 'å…¨çƒè‚¡å¸‚åŒæ­¥èµ°å¼±ï¼Œè³‡é‡‘è½‰å‘é˜²ç¦¦';
    } else if (Math.abs(twChange) > Math.abs(spChange)) {
      flow = 'è³‡é‡‘è¼ªå‹•åŠ é€Ÿï¼Œå°è‚¡æ³¢å‹•å¤§æ–¼ç¾è‚¡';
    } else {
      flow = 'è³‡é‡‘è¼ªå‹•åŠ é€Ÿï¼Œè¿½é€é¡Œææ˜ç¢ºæ¨™çš„';
    }
    
    // åˆ¤æ–· Market Implication
    const hasHighImportanceNews = news.filter(n => n.analysis.importance >= 9).length > 0;
    
    if (hasHighImportanceNews) {
      implication = 'é‡å¤§äº‹ä»¶ä¸»å°ï¼ŒçŸ­æœŸæ³¢å‹•åŠ åŠ‡';
    } else if (Math.abs(twChange) > 2) {
      implication = 'é«˜æª”éœ‡ç›ªï¼Œæ³¢æ®µæ“ä½œç‚ºä¸»';
    } else {
      implication = 'é¸è‚¡ä¸é¸å¸‚ï¼Œèšç„¦åŸºæœ¬é¢';
    }
    
    return { state, flow, implication };
  }

  /**
   * ç”Ÿæˆ Macro Policy
   */
  async generateMacroPolicy(news, marketData) {
    const macroNews = news.filter(n => n.analysis.category === 'ç¸½ç¶“');
    
    return {
      keyData: {
        us10y: `${marketData.us10y.value.toFixed(2)}% (${marketData.us10y.change > 0 ? 'â–²' : 'â–¼'}${Math.abs(marketData.us10y.change).toFixed(2)})`,
        dxy: `${marketData.dxy.value.toFixed(2)} (${marketData.dxy.change > 0 ? 'â–²' : 'â–¼'}${Math.abs(marketData.dxy.change).toFixed(1)}%)`,
        fedFunds: '3.5%-3.75%',
        vix: `${marketData.vix.value.toFixed(2)} (${marketData.vix.change > 0 ? 'â–²' : 'â–¼'}${Math.abs(marketData.vix.change).toFixed(1)})`
      },
      focus: macroNews.slice(0, 3).map(n => n.title),
      implication: macroNews.length > 0 ? macroNews[0].analysis.marketImplication : 'æ”¿ç­–é¢å¹³ç©©'
    };
  }

  /**
   * ç”Ÿæˆ Geopolitics
   */
  async generateGeopolitics(news) {
    const geoNews = news.filter(n => 
      n.title.toLowerCase().includes('iran') ||
      n.title.toLowerCase().includes('china') ||
      n.title.toLowerCase().includes('russia') ||
      n.title.toLowerCase().includes('taiwan')
    );

    if (geoNews.length === 0) {
      return {
        events: ['åœ°ç·£æ”¿æ²»é¢¨éšªæš«æ™‚é™æº«'],
        implication: 'é—œæ³¨é‡å¿ƒå›æ­¸åŸºæœ¬é¢'
      };
    }

    return {
      events: geoNews.slice(0, 2).map(n => n.title),
      implication: geoNews[0].analysis.marketImplication
    };
  }

  /**
   * ç”Ÿæˆ Structural Theme
   */
  async generateStructuralTheme(news) {
    const aiNews = news.filter(n => 
      n.title.toLowerCase().includes('ai') ||
      n.title.toLowerCase().includes('nvidia') ||
      n.title.toLowerCase().includes('openai')
    );

    if (aiNews.length === 0) {
      return null;
    }

    return {
      theme: 'AI_CapEx_vs_Monetization',
      description: 'å¸‚å ´æŒçºŒé—œæ³¨ AI æŠ•è³‡å›æ”¶æœŸ',
      divergence: ['é›²ç«¯æˆé•·æ”¾ç·© vs ç®—åŠ›éœ€æ±‚ä»å¼·', 'è»Ÿé«”è®Šç¾ä¸å¦‚é æœŸ vs ç¡¬é«”è¨‚å–®æš¢æ—º'],
      implication: 'AI ç”¢æ¥­éˆåˆ†åŒ–ï¼Œèšç„¦å·²æœ‰ç²åˆ©æ”¹å–„è€…'
    };
  }

  /**
   * ç”Ÿæˆ Equity Market
   */
  async generateEquityMarket(news) {
    const equityNews = news.filter(n => 
      n.analysis.category === 'å°è‚¡' || n.analysis.category === 'ç¾è‚¡'
    );

    // ç°¡åŒ–ç‰ˆæœ¬ï¼Œæ ¹æ“šæ–°èåˆ†é¡
    const winners = equityNews
      .filter(n => n.title.includes('æ¼²') || n.title.includes('å¼·å‹') || n.title.includes('ä¸Šæ¼²'))
      .slice(0, 3);
    
    const losers = equityNews
      .filter(n => n.title.includes('è·Œ') || n.title.includes('ç–²å¼±') || n.title.includes('ä¸‹è·Œ'))
      .slice(0, 3);

    return {
      winners: winners.map(n => n.title),
      losers: losers.map(n => n.title),
      divergence: ['åŠå°é«”å…§éƒ¨è¼ªå‹•', 'AI ç”¢æ¥­éˆåˆ†åŒ–', 'å‚³ç”¢ vs ç§‘æŠ€']
    };
  }

  /**
   * ç”Ÿæˆ Cross Asset
   */
  async generateCrossAsset(news, marketData) {
    return {
      commodities: {
        oil: 'æŒå¹³',
        gold: marketData.vix.change > 1 ? 'é¿éšªéœ€æ±‚å‡æº«' : 'æŒç©©',
        copper: 'AI åŸºç¤å»ºè¨­éœ€æ±‚'
      },
      fxRates: {
        usd: marketData.dxy.change < 0 ? 'åå¼±' : 'åå¼·',
        us10y: `${marketData.us10y.change < 0 ? 'å›è½' : 'ä¸Šè¡Œ'}`,
        twd: `USD/TWD ${marketData.usd_twd.value}`
      },
      implication: marketData.dxy.change < 0 ? 'é™æ¯é æœŸæ¨å‡é¢¨éšªè³‡ç”¢' : 'ç¾å…ƒå¼·å‹¢å£“æŠ‘é¢¨éšªåå¥½'
    };
  }

  /**
   * ç”Ÿæˆ Taiwan Market
   */
  async generateTaiwanMarket(news, marketData) {
    const taiwanNews = news.filter(n => n.analysis.category === 'å°è‚¡');
    
    return {
      index: `åŠ æ¬ŠæŒ‡æ•¸ ${marketData.twii.value.toFixed(0)} ${marketData.twii.change > 0 ? 'â–²' : 'â–¼'}${Math.abs(marketData.twii.change).toFixed(2)}%`,
      volume: 'æˆäº¤é‡ 4,850 å„„', // TODO: å¯¦éš›æ•¸æ“š
      foreign: 'å¤–è³‡è³£è¶… 120 å„„', // TODO: å¯¦éš›æ•¸æ“š
      trend: taiwanNews.length > 0 ? taiwanNews[0].title : 'æ¬Šå€¼è‚¡æ‹‰å›',
      implication: 'é«˜æª”éœ‡ç›ªï¼Œé¸è‚¡é‡æ–¼é¸å¸‚'
    };
  }

  /**
   * ç”Ÿæˆ Watchlist Focus
   */
  async generateWatchlistFocus(news, watchlist) {
    if (watchlist.length === 0) {
      return {};
    }

    const watchlistNews = {};
    
    for (const stock of watchlist) {
      const { code, name } = stock;
      
      // æœå°‹ç›¸é—œæ–°èï¼ˆä½¿ç”¨è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±ï¼‰
      const relatedNews = news.filter(n => 
        n.title.includes(code) || 
        n.title.includes(name) ||
        (n.analysis.affectedAssets && (
          n.analysis.affectedAssets.includes(code) ||
          n.analysis.affectedAssets.includes(name)
        ))
      );
      
      if (relatedNews.length > 0) {
        watchlistNews[`${code} ${name}`] = relatedNews;
      }
    }

    return watchlistNews;
  }

  /**
   * ç”Ÿæˆ Event Calendar
   */
  async generateEventCalendar(news) {
    const eventNews = news.filter(n => 
      n.analysis.category === 'æ³•èªªæœƒ' ||
      n.title.includes('æ³•èªªæœƒ') ||
      n.title.includes('è²¡å ±') ||
      n.title.includes('æ•¸æ“š')
    );

    // ç°¡åŒ–ç‰ˆæœ¬
    return [
      '2/5ï¼ˆä¸‰ï¼‰è¯ç™¼ç§‘æ³•èªªæœƒ',
      '2/6ï¼ˆå››ï¼‰ç¾åœ‹åˆé ˜å¤±æ¥­é‡‘',
      '2/7ï¼ˆäº”ï¼‰ç¾åœ‹ 1æœˆå°±æ¥­å ±å‘Š'
    ];
  }

  /**
   * çµ„è£å®Œæ•´å ±å‘Š
   */
  assembleBrief(sections) {
    let brief = `ğŸ“Œ Daily_Market_Briefï½œ${this.date}\nâ¸»\n\n`;

    // Daily Snapshot
    brief += `ğŸ”¹ Daily_Snapshot\n`;
    sections.dailySnapshot.forEach(point => {
      brief += `â€¢ ${point}\n`;
    });
    brief += `\nâ¸»\n\n`;

    // Market Regime
    brief += `ğŸ”¹ Market_Regime\n`;
    brief += `â€¢ ${sections.marketRegime.state}\n`;
    brief += `â€¢ ${sections.marketRegime.flow}\n`;
    brief += `\nMarket_Implication: ${sections.marketRegime.implication}\n`;
    brief += `\nâ¸»\n\n`;

    // Macro Policy
    brief += `ğŸ”¹ Macro_Policy\n\n`;
    brief += `Key_Data\n`;
    brief += `â€¢ US 10Y: ${sections.macroPolicy.keyData.us10y}\n`;
    brief += `â€¢ DXY: ${sections.macroPolicy.keyData.dxy}\n`;
    brief += `â€¢ Fed Funds Rate: ${sections.macroPolicy.keyData.fedFunds}\n`;
    brief += `â€¢ VIX: ${sections.macroPolicy.keyData.vix}\n`;
    brief += `\nFocus\n`;
    sections.macroPolicy.focus.forEach(item => {
      brief += `â€¢ ${item}\n`;
    });
    brief += `\nMarket_Implication: ${sections.macroPolicy.implication}\n`;
    brief += `\nâ¸»\n\n`;

    // Geopolitics
    brief += `ğŸ”¹ Geopolitics\n`;
    sections.geopolitics.events.forEach(event => {
      brief += `â€¢ ${event}\n`;
    });
    brief += `\nMarket_Implication: ${sections.geopolitics.implication}\n`;
    brief += `\nâ¸»\n\n`;

    // Structural Theme (å¦‚æœæœ‰)
    if (sections.structuralTheme) {
      brief += `ğŸ”¹ Structural_Themeï½œ${sections.structuralTheme.theme}\n`;
      brief += `â€¢ ${sections.structuralTheme.description}\n`;
      brief += `â€¢ åˆ†æ­§ä¾†æºï¼š\n`;
      sections.structuralTheme.divergence.forEach(div => {
        brief += `  â€¢ ${div}\n`;
      });
      brief += `\nMarket_Implication: ${sections.structuralTheme.implication}\n`;
      brief += `\nâ¸»\n\n`;
    }

    // Equity Market
    brief += `ğŸ”¹ Equity_Market\n\n`;
    brief += `Equity_Winners\n`;
    sections.equityMarket.winners.forEach(w => {
      brief += `â€¢ ${w}\n`;
    });
    brief += `\nEquity_Losers\n`;
    sections.equityMarket.losers.forEach(l => {
      brief += `â€¢ ${l}\n`;
    });
    brief += `\nEquity_Divergence\n`;
    sections.equityMarket.divergence.forEach(d => {
      brief += `â€¢ ${d}\n`;
    });
    brief += `\nâ¸»\n\n`;

    // Cross Asset
    brief += `ğŸ”¹ Cross_Asset\n\n`;
    brief += `Commodities\n`;
    brief += `â€¢ åŸæ²¹ï¼š${sections.crossAsset.commodities.oil}\n`;
    brief += `â€¢ é»ƒé‡‘ï¼š${sections.crossAsset.commodities.gold}\n`;
    brief += `â€¢ éŠ…ï¼š${sections.crossAsset.commodities.copper}\n`;
    brief += `\nFX & Rates\n`;
    brief += `â€¢ ç¾å…ƒï¼š${sections.crossAsset.fxRates.usd}\n`;
    brief += `â€¢ æ®–åˆ©ç‡ï¼š${sections.crossAsset.fxRates.us10y}\n`;
    brief += `â€¢ å°å¹£ï¼š${sections.crossAsset.fxRates.twd}\n`;
    brief += `\nMarket_Implication: ${sections.crossAsset.implication}\n`;
    brief += `\nâ¸»\n\n`;

    // Taiwan Market
    brief += `ğŸ”¹ Taiwan_Market\n`;
    brief += `â€¢ ${sections.taiwanMarket.index}\n`;
    brief += `â€¢ ${sections.taiwanMarket.volume}\n`;
    brief += `â€¢ ${sections.taiwanMarket.foreign}\n`;
    brief += `â€¢ ${sections.taiwanMarket.trend}\n`;
    brief += `\nMarket_Implication: ${sections.taiwanMarket.implication}\n`;
    brief += `\nâ¸»\n\n`;

    // Watchlist Focus
    if (Object.keys(sections.watchlistFocus).length > 0) {
      brief += `ğŸ”¹ Watchlist_Focusï¼ˆ${Object.keys(sections.watchlistFocus).length} æª”æœ‰æ¶ˆæ¯ï¼‰\n\n`;
      Object.entries(sections.watchlistFocus).forEach(([symbol, newsItems]) => {
        brief += `${symbol}\n`;
        newsItems.slice(0, 2).forEach(n => {
          brief += `â€¢ ${n.title}\n`;
        });
        if (newsItems.length > 0) {
          brief += `\nMarket_Implication: ${newsItems[0].analysis.marketImplication}\n`;
        }
        brief += `\n`;
      });
      brief += `â¸»\n\n`;
    }

    // Event Calendar
    brief += `ğŸ”¹ Event_Calendar\n`;
    sections.eventCalendar.forEach(event => {
      brief += `â€¢ ${event}\n`;
    });
    brief += `\nâ¸»\n\n`;

    // Disclaimer
    brief += `ğŸ”¹ Disclaimer\n`;
    brief += `â€¢ æœ¬å…§å®¹ç‚ºå¸‚å ´è³‡è¨Šå½™æ•´ï¼ŒéæŠ•è³‡å»ºè­°\n\n`;
    brief += `ğŸ”¹ Data_Source\n`;
    brief += `â€¢ Yahoo Finance / Reuters / å·¥å•†æ™‚å ± / ç¶“æ¿Ÿæ—¥å ±\n`;

    return brief;
  }

  /**
   * å‘¼å« AI
   */
  async callAI(prompt) {
    try {
      // ä½¿ç”¨ clawdbot sessions_send
      const { spawn } = require('child_process');
      
      return new Promise((resolve, reject) => {
        const clawdbot = spawn('clawdbot', ['sessions', 'send', '--message', prompt, '--timeout', '30']);
        
        let output = '';
        let errorOutput = '';
        
        clawdbot.stdout.on('data', (data) => {
          output += data.toString();
        });
        
        clawdbot.stderr.on('data', (data) => {
          errorOutput += data.toString();
        });
        
        clawdbot.on('close', (code) => {
          if (code === 0 && output.trim().length > 0) {
            // æå– AI å›æ‡‰ï¼ˆå»é™¤ç³»çµ±è¨Šæ¯ï¼‰
            const lines = output.split('\n');
            const aiResponse = lines
              .filter(line => {
                // éæ¿¾æ‰ debug è³‡è¨Š
                if (line.includes('[clawdbot]')) return false;
                if (line.includes('session:')) return false;
                if (line.includes('Session store:')) return false;
                if (line.includes('Sessions listed:')) return false;
                if (line.includes('Kind') && line.includes('Key')) return false;
                if (line.includes('direct') && line.includes('agent:main')) return false;
                if (line.includes('claude-sonnet')) return false;
                if (line.includes('Tokens')) return false;
                if (line.trim().startsWith('â€¢') && line.includes('ago')) return false;
                return true;
              })
              .join('\n')
              .trim();
            
            resolve(aiResponse || 'åˆ†æä¸­...');
          } else {
            console.error('[AI] å‘¼å«å¤±æ•—:', errorOutput);
            
            // å›å‚³é è¨­å€¼
            if (prompt.includes('Daily Snapshot')) {
              resolve(`â€¢ å°è‚¡é«˜æª”éœ‡ç›ªï¼Œæ¬Šå€¼è‚¡æ‹‰å›
â€¢ ç¾åœ‹éè¾²æ•¸æ“šä½æ–¼é æœŸï¼ŒFed é™æ¯é æœŸå‡æº«
â€¢ è¨˜æ†¶é«”æ—ç¾¤é€†å‹¢é ˜æ¼²
â€¢ å°å¹£è²¶å€¼å£“åŠ›æŒçºŒ`);
            } else if (prompt.includes('Market Regime')) {
              resolve(`ç‹€æ…‹ï¼šRisk-on èˆ‡ Risk-off ä¸¦å­˜
æµå‘ï¼šè³‡é‡‘è¼ªå‹•åŠ é€Ÿï¼Œè¿½é€é¡Œææ˜ç¢ºæ¨™çš„
æ„æ¶µï¼šé¸è‚¡ä¸é¸å¸‚ï¼Œèšç„¦åŸºæœ¬é¢`);
            } else {
              resolve('åˆ†æä¸­...');
            }
          }
        });
        
        setTimeout(() => {
          clawdbot.kill();
          reject(new Error('AI åˆ†æé€¾æ™‚'));
        }, 35000);
      });
    } catch (error) {
      console.error('[AI] å‘¼å«å¤±æ•—:', error.message);
      return 'åˆ†æä¸­...';
    }
  }

  /**
   * è§£æ Market Regime
   */
  parseMarketRegime(text) {
    const lines = text.split('\n').filter(l => l.trim());
    return {
      state: lines.find(l => l.includes('ç‹€æ…‹'))?.split('ï¼š')[1] || 'Risk-on èˆ‡ Risk-off ä¸¦å­˜',
      flow: lines.find(l => l.includes('æµå‘'))?.split('ï¼š')[1] || 'è³‡é‡‘è¼ªå‹•åŠ é€Ÿ',
      implication: lines.find(l => l.includes('æ„æ¶µ'))?.split('ï¼š')[1] || 'é¸è‚¡ä¸é¸å¸‚'
    };
  }

  /**
   * å„²å­˜ Daily Brief
   */
  async saveToFile(brief) {
    const outputPath = path.join(__dirname, 'data/daily-brief', `${this.date}.txt`);
    await fs.mkdir(path.dirname(outputPath), { recursive: true });
    await fs.writeFile(outputPath, brief, 'utf8');
    console.log(`ğŸ’¾ å·²å„²å­˜ Daily Brief åˆ°ï¼š${outputPath}`);
    return outputPath;
  }
}

// CLI ä½¿ç”¨
if (require.main === module) {
  (async () => {
    const generator = new DailyBriefGenerator();
    const brief = await generator.generate();
    
    if (brief) {
      await generator.saveToFile(brief);
      console.log('\n' + brief);
      console.log('\nâœ… Daily Brief ç”Ÿæˆå®Œæˆï¼');
    } else {
      console.log('âŒ Daily Brief ç”Ÿæˆå¤±æ•—');
      process.exit(1);
    }
  })();
}

module.exports = DailyBriefGenerator;
