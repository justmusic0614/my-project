agent_name: Clawbot_Research_Runtime
version: ultra_runtime_cost_optimized_v3_merged_patch31_implemented
mode: Telegram
timezone: Asia/Taipei
language: zh-TW
role: Research Signal Renderer

# ============================================================================
# 1. NORMALIZE 與翻譯規則
# ============================================================================
normalize:
  translation_policy:
    description: "英文來源必須先完整翻譯成中文，再提取事實"
    implementation: "增強詞典映射（當前版本）；未來可升級為 LLM 翻譯"
    forbidden: "禁止片段翻譯（no 'Add/to/From' 殘留）"
  
  proper_noun_allowlist:
    core_tokens:
      - Fed
      - ECB
      - BOJ
      - FOMC
      - GDP
      - CPI
      - PPI
      - PMI
      - VIX
      - WTI
      - DXY
      - TSMC
      - AI
      - GPU
      - US10Y
      - SPX
      - Nasdaq
    extended_tokens:
      - "S&P"
      - Apple
      - Microsoft
      - Google
      - Amazon
      - Meta
      - Nvidia
      - Tesla
      - UMC
      - Foxconn
      - Trump
      - Biden
      - Powell
      - USD
      - TWD
      - EUR
      - JPY
    rule: "核心列表不翻譯；其他英文詞必須翻譯或移除"
  
  apostrophe_fixer:
    rule: "X's => X 的"
    examples:
      - "ECB's => ECB 的"
      - "India's => India 的"
  
  fragment_detector:
    trigger_conditions:
      - "包含 >= 2 個英文片段"
      - "包含介詞 {to, from, with, add, on, in, at, for, by}"
    action:
      - "標記為 BROKEN_TRANSLATION"
      - "改寫（詞典映射）"
      - "再改寫（詞典映射）"
      - "仍破碎 => 丟棄"
    rewrite_method: "詞典映射（非 LLM）"
  
  english_residue_gate:
    threshold: 0.25  # 25% 英文字母（排除 allowlist 後）
    action:
      - "第一次改寫"
      - "第二次改寫"
      - "仍超過 => 丟棄"
    exclude_from_ratio: "proper_noun_allowlist 所有詞"
  
  translation_dictionary:
    prepositions:
      to: 至
      from: 來自
      From: 來自
      with: 隨著
      With: 隨著
      on: 於
      On: 於
      in: 在
      In: 在
      at: 於
      At: 於
      for: 為
      For: 為
      by: 由
      By: 由
    verbs:
      Add: 增加
      Adds: 增加
      Is: 為
      Are: 為
      Vanishes: 消失
      Vanish: 消失
      Slide: 下滑
      Slides: 下滑
      Rise: 上升
      Rises: 上升
      Fall: 下跌
      Falls: 下跌
      Rally: 反彈
      Rallies: 反彈
    adjectives_nouns:
      Latest: 最新
      Risk: 風險
      Risks: 風險
      Outlook: 展望
      Growth: 成長
      Inflation: 通膨
      Blow: 打擊
      Traders: 交易員
      Pressure: 壓力
      Budget: 預算
      Spending: 支出
      Push: 推動
      Most: 最
      Since: 自
      After: 之後
      Amid: 因應

# ============================================================================
# 2. EVENT CANONICALIZATION 與 DEDUP 規則
# ============================================================================
canonical_event:
  event_id_formula: "hash(entity + event_type + daily_window)"
  
  entity_extraction:
    method: "關鍵實體匹配"
    entities:
      - Fed
      - TSMC
      - 台積電
      - Trump
      - Warsh
      - Bitcoin
      - 比特幣
      - "S&P 500"
      - Nasdaq
      - TAIEX
      - 台股
      - GDP
      - CPI
      - 央行
    fallback: "無明確實體時用標題前 20 字"
  
  canonical_fact_rules:
    max_length: 90  # 字符
    tone: "中性事實"
    forbidden:
      - "情緒性動詞"
      - "投資建議語氣"
      - "預測性語言"
  
  ownership_rule: "每個事件只在一個 section 出現完整 bullet（不跨 section 重複）"
  
  deduplication_method: "標題相似度（Levenshtein distance）"
  similarity_threshold: 0.85

# ============================================================================
# 3. RELEVANCE FILTERING 與 DROP 條件
# ============================================================================
relevance_gate:
  keep_categories:
    macro_policy:
      - macro
      - policy
      - central bank
      - liquidity
      - rates
      - fx
    mega_cap:
      - mega-cap earnings
      - AI capex
    cross_asset:
      - USD
      - UST
      - oil
      - gold
      - VIX
      - cross-asset flows
    taiwan_core:
      - TAIEX
      - TWD
      - major supply chain
      - "台積電/聯電/鴻海 + (財報/投資/擴廠/產能/技術/供應鏈)"
  
  hard_drop_categories:
    lifestyle:
      - 房仲
      - 房地產
      - 租金
      - 退休資產
    military:
      - 國防
      - 軍事
      - 武器
      - 飛彈
      - 潛艦
      - 海鯤
    sports_entertainment:
      - 體育
      - 球員
      - 賽事
      - 奧運
    kol_media:
      - 網紅
      - YouTuber
      - Podcast
      - 直播
    clickbait_investment:
      - 怎麼走
      - 紅包行情
      - 藏寶圖
      - 向錢衝
      - 首選
      - 佈局
      - 多頭
      - 空頭
      - 股王
      - 飆股
      - 剽悍
  
  expert_advice_patterns:
    - "[姓名]：.*(建議|認為|表示|看法|延續|格局|配置)"
    - "專家："
    - "分析師："
    - ".*：.*(多頭|空頭|看好|看壞|佈局)"
  
  stock_filtering:
    mega_cap_only:
      taiwan:
        - 台積電
        - TSMC
        - 聯電
        - UMC
        - 鴻海
        - Foxconn
      us:
        - Apple
        - Microsoft
        - Google
        - Amazon
        - Meta
        - Nvidia
        - Tesla
    excluded_stocks:
      - 京鼎
      - 景碩
      - 信驊
      - 昇達科
      - 大立光
      - 力積電
      - 世界
    rule: "提到個股必須是 mega cap，或為產業新聞（半導體/AI/晶片）"
  
  score_gate:
    threshold: 45
    action: "relevance_score < 45 => drop（記錄 ban_reason）"

# ============================================================================
# 4. MINIMUM EVENT QUOTA 與 BACKFILL 規則
# ============================================================================
quota_management:
  target_event_count:
    preferred_min: 8
    preferred_max: 12
    hard_max: 12
  
  minimum_quota_rule:
    trigger: "total_events < 8"
    backfill_priority:
      - priority: 1
        sections:
          - macro_policy
          - cross_asset
        condition: "relevance_score >= 45"
      - priority: 2
        sections:
          - equity_market
        condition: "relevance_score >= 45 && (AI 或 capex 相關)"
      - priority: 3
        sections:
          - daily_snapshot
        condition: "relevance_score >= 45"
    
    split_rule: "允許拆分一個主題為 2 個不同 canonical facts（如果內容差異明確）"
    forbidden: "永不回填已被 drop 的類別（lifestyle/military/sports/KOL）"
  
  current_implementation: "從 uniqueNews 中回填，優先 macro/cross_asset"

# ============================================================================
# 5. SECTION ALLOCATION 與 QUOTA
# ============================================================================
section_router:
  routing_rules:
    macro_policy:
      keywords:
        - Fed
        - ECB
        - BoJ
        - 央行
        - 聯準會
        - FOMC
        - 貨幣政策
        - GDP
        - CPI
        - PMI
        - 通膨
        - 政策
        - 利率
        - 升息
        - 降息
        - 流動性
        - 信用
        - 債券
        - 殖利率
      priority: 1
    
    equity_market:
      keywords:
        - earnings
        - 財報
        - 法說會
        - capex
        - 資本支出
        - Apple
        - Microsoft
        - Google
        - Amazon
        - Meta
        - Nvidia
        - Tesla
        - 台積電
        - TSMC
        - AI
        - GPU
        - 晶片
        - 半導體
      priority: 2
    
    cross_asset:
      keywords:
        - USD
        - DXY
        - 美元
        - VIX
        - 避險
        - 黃金
        - 石油
        - crude
        - WTI
        - commodities
        - 商品
        - UST
        - 美債
      priority: 3
    
    taiwan_market:
      keywords:
        - TAIEX
        - 台股
        - 加權
        - TWD
        - 台幣
        - 台灣央行
      priority: 4
    
    daily_snapshot:
      rule: "預設（無明確歸屬）"
      priority: 5
  
  section_quotas:
    daily_snapshot:
      min: 3
      max: 5
    macro_policy:
      min: 0
      max: 3
      empty_display: "N/A"
    equity_market:
      min: 0
      max: 3
      empty_display: "N/A"
    cross_asset:
      min: 3
      max: 5
    taiwan_market:
      min: 0
      max: 3
      empty_display: "N/A"
    event_watch:
      min: 0
      max: 3
      empty_display: "N/A"
      rule: "僅輸出即將到來的重大數據/事件（如有提供）；不可推測"

# ============================================================================
# 6. RISK RADAR 觸發條件
# ============================================================================
risk_radar:
  trigger_condition:
    importance_level: "CRITICAL"
    confidence_level: "HIGH 或 MEDIUM"
    rule: "LOW confidence 時不輸出 Risk Radar"
  
  components:
    trigger:
      source: "macro/systemic only (from Macro & Policy or Cross Asset)"
      forbidden: "不可用個股事件或 Taiwan 單一市場事件"
    
    immediate_reaction:
      data_source: "verified_key_data only"
      rules:
        - "市場關閉/延遲/低信心 => N/A + alert"
        - "台股週末 changePct=0 => N/A（市場關閉/延遲）"
        - "美股 confidence < MEDIUM => N/A（數據不足）"
      forbidden: "不可編造數字或推測反應"
    
    key_uncertainty:
      tone: "中性措辭"
      templates:
        - "政策路徑與時機"
        - "貿易政策發展"
        - "加密貨幣監管動向"
        - "後續發展與市場反應"
      forbidden: "預測性語言"

# ============================================================================
# 7. CONFIDENCE GOVERNOR 規則
# ============================================================================
confidence_governor:
  confidence_levels:
    HIGH:
      criteria:
        - "所有市場數據 confidence_tier = A 或 B"
      report_behavior:
        length: "normal"
        tone: "正常"
        risk_radar: "允許（如果 importance = CRITICAL）"
    
    MEDIUM:
      criteria:
        - "存在 C 級（延遲）但無 D 級"
        - "或週末時延遲數據視為正常"
      report_behavior:
        length: "正常（週末不縮短）"
        tone: "謹慎措辭"
        risk_radar: "允許（如果 importance = CRITICAL）"
        warning: "不顯示警示（週末延遲正常）"
    
    LOW:
      criteria:
        - "存在 D 級（缺失）"
        - "或平日時全是 C/D（異常延遲）"
      report_behavior:
        length: "縮短 40%（bullet 減少）"
        tone: "強調數據限制"
        risk_radar: "禁止"
        warning: "⚠️ Data availability limited"
  
  weekend_tolerance:
    rule: "週六/週日延遲數據不降級為 LOW"
    implementation: "isWeekend && tierC > 0 => MEDIUM"

# ============================================================================
# 8. SYSTEM HEALTH 生成規則
# ============================================================================
system_health:
  required_fields:
    missing_fields:
      type: "array"
      description: "缺失的數據欄位"
      example: ["tw_stock", "us10y"]
      empty_value: "None"
    
    confidence_distribution:
      type: "object"
      description: "Confidence tier 計數"
      format: "{A: count, B: count, C: count, D: count}"
      calculation: "從所有 verified_key_data 的 metadata 統計"
    
    external_data_status:
      type: "array"
      description: "外部數據源狀態"
      format: ["Provider: STATUS"]
      allowed_status:
        - ACTIVE
        - PARTIAL
        - FAILED
      example:
        - "Yahoo Finance: ACTIVE"
        - "US Market Data: ACTIVE"
        - "FX Data: ACTIVE"
    
    ocr_summary:
      current_value: "OCR: not implemented"
      future_format: "OCR: used X articles, Y low confidence"
    
    alerts:
      max_count: 10
      format: "具體、可操作"
      rules:
        - "DELAYED 數據 => alert"
        - "tier C/D => alert"
        - "missing fields => alert"
        - "事件數量不足 => alert"
      forbidden:
        - "空白行"
        - "Marketing KPI（完整度 100%）"
        - "Backend debug steps（除非明確要求）"
  
  alert_generation_rules:
    - condition: "tier C 或 D > 0"
      alert: "Low confidence data detected: {count} field(s)"
    
    - condition: "missing_fields.length > 0"
      alert: "Missing data: {fields}"
    
    - condition: "total_materials < min_news_count"
      alert: "Material count below threshold ({actual}/{expected})"

# ============================================================================
# 9. POST RENDER BULLET 修正規則
# ============================================================================
post_render_bullet_guard:
  implementation: "確定性處理（無 LLM）"
  
  length_control:
    preferred_length: 28  # 中文字符
    hard_cap: 45  # 中文字符
    calculation_method: "中文字 = 1，英文/數字/符號 = 0.5"
    action:
      - "length > 45 => 截斷至 42 + '…'"
    enforcement: "POST_RENDER（報告生成後）"
  
  english_ratio_check:
    threshold: 0.15  # 15% 英文字母（排除 allowlist）
    action:
      - "ratio > 15% => 移除非 allowlist 英文詞"
    method: "詞過濾（非改寫）"
  
  media_tag_removal:
    patterns:
      - "《.*》"
      - "【.*】"
      - "〈.*〉"
    timing: "在 BulletFormatter 階段（非 post-render）"
  
  expert_name_removal:
    pattern: "^[中文姓氏][^：:]+[：:]\\s*"
    timing: "在 BulletFormatter 階段（非 post-render）"
  
  fragment_removal:
    rule: "移除孤立的英文介詞/連接詞"
    forbidden_alone:
      - to
      - from
      - with
      - add
      - on
      - in

# ============================================================================
# SECTION QUOTAS（輸出限制）
# ============================================================================
section_quotas:
  daily_snapshot:
    min: 3
    max: 5
  macro_policy:
    min: 1
    max: 3
    empty: "N/A"
  equity_market_structure:
    min: 1
    max: 3
    empty: "N/A"
  cross_asset_signals:
    min: 3
    max: 5
  taiwan_market:
    min: 0
    max: 3
    empty: "N/A"
  event_watch:
    min: 0
    max: 3
    empty: "N/A"

# ============================================================================
# MARKET REGIME（固定模板）
# ============================================================================
market_regime:
  output_rule: "僅輸出一句話（使用固定模板）"
  
  templates:
    - id: 1
      text: "中期趨勢偏多，但短線波動上升，事件驅動性提高"
      trigger: "美股 > 1%"
    
    - id: 2
      text: "市場偏防禦，資金轉向避險資產，波動度上升"
      trigger: "美股 < -1% 或 VIX 提及"
    
    - id: 3
      text: "市場進入區間震盪，等待關鍵事件與數據指引"
      trigger: "美股 -0.5% ~ 0.5%"
    
    - id: 4
      text: "風險偏好回升，但對政策/通膨不確定性仍高"
      trigger: "其他情況"
  
  selection_logic: "基於 verified_key_data.us_stock.sp500_change_pct"

# ============================================================================
# VERIFIED KEY DATA（嚴格型別）
# ============================================================================
verified_key_data:
  required_fields:
    - SPX
    - NASDAQ
    - US10Y
    - DXY
    - VIX
    - WTI
    - GOLD
    - USD/TWD
    - TAIEX
  
  field_structure:
    required_attributes:
      - value
      - provider
      - asof_label
      - confidence_tier
    
    asof_labels:
      - US_CLOSE
      - INTRADAY
      - DELAYED
      - N/A
    
    confidence_tiers:
      A: "HIGH（< 1 小時）"
      B: "MEDIUM（< 4 小時）"
      C: "LOW（< 24 小時或週末延遲）"
      D: "NONE（缺失）"
  
  strict_rules:
    volume:
      allowed: ["numeric", "N/A"]
      forbidden: ["weekend", "0", "placeholder"]
    
    percent_change:
      rule: "未知 => N/A（不可用 0.00% 佔位）"
      exception: "真實 0% 變動可顯示"
    
    tier_d_handling:
      rule: "Tier D => 強制顯示 N/A"
  
  alert_rules:
    - "DELAYED => System Health alert"
    - "tier C/D => System Health alert"
    - "missing field => System Health alert"

# ============================================================================
# IDEMPOTENCY（v0 實現）
# ============================================================================
idempotency:
  tier: v0
  implementation: "內存緩存"
  
  cache_key_formula: "workbench_date + material_count + last_item_timestamp"
  
  ttl: 1800000  # 30 分鐘（毫秒）
  
  behavior:
    cache_hit: "重用上次報告，跳過 pipeline + LLM"
    cache_miss: "執行完整 pipeline"
  
  future_upgrade:
    tier: v1
    method: "持久化存儲（SQLite or JSON file）"
    key: "material_hash"

# ============================================================================
# 成本控制
# ============================================================================
cost_control:
  llm_calls_per_run: 1  # 嚴格限制
  max_events: 12
  deterministic_checks: "僅使用確定性後處理（無第二次 LLM）"

# ============================================================================
# 當前實現狀態
# ============================================================================
implementation_status:
  completed:
    - normalize.apostrophe_fixer
    - normalize.fragment_detector
    - normalize.english_residue_gate (25%)
    - canonical_event.deduplication
    - relevance_gate.all_categories
    - quota_management.minimum_quota
    - quota_management.backfill
    - section_router.all_sections
    - risk_radar.immediate_reaction_na_handling
    - confidence_governor.weekend_tolerance
    - system_health.ocr_not_implemented
    - post_render_bullet_guard.length_control
    - post_render_bullet_guard.english_ratio
    - idempotency.v0
  
  known_issues:
    - issue: "部分英文新聞仍有殘留（'Euro Rally Is Latest Risk...'）"
      reason: "詞典映射不完整"
      workaround: "FRAGMENT_DETECTOR 已丟棄大部分破碎翻譯"
    
    - issue: "回填邏輯未能達到 8 則（當前只有 5 則）"
      reason: "可用素材太少（80 則 → 過濾後只剩 5 則符合條件）"
      solution: "需要更多新聞源或放寬 relevance_score"
    
    - issue: "Immediate Reaction 顯示 N/A（週末）"
      status: "符合規格要求（市場關閉 => N/A）"
  
  future_enhancements:
    - "完整句子翻譯（整合專業翻譯 API 或 LLM）"
    - "IDEMPOTENCY v1（持久化存儲）"
    - "Event Watch 自動抓取（財經日曆 API）"
    - "更多新聞源（增加素材池）"

# ============================================================================
# 最後更新
# ============================================================================
last_updated: "2026-02-01T11:42:00+08:00"
implemented_by: Clawbot
