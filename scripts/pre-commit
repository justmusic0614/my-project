#!/usr/bin/env bash
set -euo pipefail

files="$(git diff --cached --name-only --diff-filter=AM || true)"
[[ -z "${files}" ]] && exit 0

# Strong indicators (almost certainly secrets)
STRONG='(-----BEGIN (RSA|OPENSSH|EC) PRIVATE KEY-----|AKIA[0-9A-Z]{16}|ASIA[0-9A-Z]{16}|xox[baprs]-[A-Za-z0-9-]{10,}|sk-[A-Za-z0-9]{20,})'

# Key-value style secrets (block only when it looks like an actual value)
KV='((API[_-]?KEY|TOKEN|SECRET|PASSWORD|BOT[_-]?TOKEN|ACCESS[_-]?TOKEN)[[:space:]]*[:=][[:space:]]*[A-Za-z0-9_./+-]{20,})'

hit=0
while IFS= read -r f; do
  [[ -z "$f" ]] && continue

  # avoid self-trigger
  if [[ "$f" == "scripts/pre-commit" ]]; then
    continue
  fi

  blob="$(git show ":$f" 2>/dev/null || true)"

  if echo "$blob" | grep -nE "$STRONG" >/dev/null; then
    echo "[BLOCKED] Strong secret indicator in staged file: $f" >&2
    echo "$blob" | grep -nE "$STRONG" | head -n 20 >&2 || true
    hit=1
    continue
  fi

  if echo "$blob" | grep -nE "$KV" >/dev/null; then
    echo "[BLOCKED] Possible credential assignment in staged file: $f" >&2
    echo "$blob" | grep -nE "$KV" | head -n 20 >&2 || true
    hit=1
  fi
done <<< "$files"

if [[ "$hit" -eq 1 ]]; then
  echo "Commit aborted. Remove secrets or move them to systemd credentials / external files." >&2
  exit 1
fi
