#!/usr/bin/env node
/**
 * Market Digest Daily Brief Generator
 * ç”Ÿæˆ Daily Market Brief æ ¼å¼å ±å‘Š
 */

const fs = require('fs').promises;
const path = require('path');
const { exec } = require('child_process');
const { promisify } = require('util');
const timeHelper = require('./time-helper');

const execAsync = promisify(exec);

class DailyBriefGenerator {
  constructor(config = {}) {
    this.config = config;
    this.date = config.date || new Date().toISOString().split('T')[0];
    this.effectiveDate = timeHelper.getEffectiveQueryDate(this.date);
    this.dataStatusMessage = timeHelper.getDataStatusMessage(this.date, this.effectiveDate);
  }

  /**
   * ç”Ÿæˆå®Œæ•´ Daily Brief
   */
  async generate() {
    console.log(`ğŸ“Š ç”Ÿæˆ Daily Market Brief (${this.date})...`);

    // è¼‰å…¥è³‡æ–™
    const analyzedNews = await this.loadAnalyzedNews();
    const marketData = await this.loadMarketData();
    const watchlist = await this.loadWatchlist();
const digestBrief = await this.loadDigestBrief();
    if (analyzedNews.length === 0) {
      console.log('âš ï¸  æ²’æœ‰åˆ†æéçš„æ–°èï¼Œç„¡æ³•ç”Ÿæˆ Daily Brief');
      return null;
    }

    // ç”Ÿæˆå„å€‹ sections
    const sections = {
      advisorBrief: await this.generateAdvisorBrief(analyzedNews, marketData),
      riskDashboard: await this.generateRiskDashboard(analyzedNews, marketData),
      dailySnapshot: await this.generateDailySnapshot(analyzedNews, marketData),
      moneyFlow: await this.generateMoneyFlow(analyzedNews, marketData),
      marketRegime: await this.generateMarketRegime(analyzedNews, marketData),
      taiwanMarket: await this.generateTaiwanMarket(analyzedNews, marketData),
      sectorRotation: await this.generateSectorRotation(analyzedNews, marketData),
      macroPolicy: await this.generateMacroPolicy(analyzedNews, marketData),
      geopolitics: await this.generateGeopolitics(analyzedNews),
      structuralTheme: await this.generateStructuralTheme(analyzedNews),
      crossAsset: await this.generateCrossAsset(analyzedNews, marketData),
      watchlistFocus: await this.generateWatchlistFocus(analyzedNews, watchlist),
      eventCalendar: await this.generateEventCalendar(analyzedNews),
  digestBrief
    };

    // çµ„è£å®Œæ•´å ±å‘Š
    const brief = this.assembleBrief(sections);
    
    console.log('âœ… Daily Brief ç”Ÿæˆå®Œæˆï¼');
    return brief;
  }

  /**
   * è¼‰å…¥åˆ†æéçš„æ–°è
   */
  async loadAnalyzedNews() {
    const filePath = path.join(__dirname, 'data/news-analyzed', `${this.date}.json`);
    try {
      const content = await fs.readFile(filePath, 'utf8');
      const data = JSON.parse(content);
      return data.news || [];
    } catch (error) {
      console.error(`[Brief Generator] è®€å–åˆ†ææ–°èå¤±æ•—:`, error.message);
      return [];
    }
  }

  /**
   * è¼‰å…¥å¸‚å ´æ•¸æ“šï¼ˆå«ä¸‰å¤§æ³•äººï¼‰
   */
  async loadMarketData() {
    try {
      // è¼‰å…¥ config
      const configPath = path.join(__dirname, 'config.json');
      const config = JSON.parse(await fs.readFile(configPath, 'utf8'));
      
      // ä½¿ç”¨ç¾æœ‰çš„ fetcher
      const MarketDataFetcher = require('./backend/fetcher');
      const fetcher = new MarketDataFetcher(config);
      
      const data = await fetcher.fetchMarketData();
      
      // è½‰æ›ç‚ºçµ±ä¸€æ ¼å¼
      return {
        twii: {
          value: data.tw_stock?.data?.close || 31801.27,
          change: data.tw_stock?.data?.changePct || -0.82
        },
        sp500: {
          value: data.us_stock?.data?.close || 6882.72,
          change: data.us_stock?.data?.changePct || -1.37
        },
        usd_twd: {
          value: data.fx?.data?.close || 31.69,
          change: data.fx?.data?.changePct || 1.04
        },
        us10y: { value: data.us_treasury?.data?.close || 4.48, change: data.us_treasury?.data?.changePct || 0 }, // å¾ fetcher è®€å–
        dxy: { value: data.dxy?.data?.close || 107.8, change: data.dxy?.data?.changePct || 0 },     // å¾ fetcher è®€å–
        vix: { value: data.vix?.data?.close || 16.2, change: data.vix?.data?.changePct || 0 },      // å¾ fetcher è®€å–
        
        // ä¸‰å¤§æ³•äººæ•¸æ“š
        institutional_investors: data.institutional_investors || null,
        institutional_investors_history: data.institutional_investors_history || []
      };
    } catch (error) {
      console.error('[Market Data] è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨ latest.json å‚™ä»½:', error.message);
      // å˜—è©¦å¾ latest.json è®€å–å‚™ä»½æ•¸æ“š
      try {
        const latestPath = path.join(__dirname, 'data/runtime/latest.json');
        const latestData = JSON.parse(await fs.readFile(latestPath, 'utf8'));
        const verified = latestData.verified_key_data || {};
        
        return {
          twii: { 
            value: verified.tw_stock?.taiex_close || 31801.27, 
            change: verified.tw_stock?.taiex_change_pct || -0.82 
          },
          sp500: { 
            value: verified.us_stock?.sp500_close || 6882.72, 
            change: verified.us_stock?.sp500_change_pct || -1.37 
          },
          usd_twd: { 
            value: verified.fx?.usdtwd || 31.69, 
            change: verified.fx?.usdtwd_change_pct || 1.04 
          },
          us10y: { value: 4.48, change: 0 },
          dxy: { value: 107.8, change: 0 },
          vix: { value: 16.2, change: 0 },
          institutional_investors: null,
          institutional_investors_history: []
        };
      } catch (e) {
        console.error('[Market Data] latest.json ä¹Ÿè®€å–å¤±æ•—ï¼Œä½¿ç”¨æœ€çµ‚é è¨­å€¼');
        return {
          twii: { value: 31801.27, change: -0.82 },
          sp500: { value: 6882.72, change: -1.37 },
          usd_twd: { value: 31.69, change: 1.04 },
          us10y: { value: 4.48, change: 0 },
          dxy: { value: 107.8, change: 0 },
          vix: { value: 16.2, change: 0 },
          institutional_investors: null,
          institutional_investors_history: []
        };
      }
    }
  }
  }
  /**
   * è¼‰å…¥ watchlist
   */
  async loadWatchlist() {
    const filePath = path.join(__dirname, 'data/watchlist.json');
    try {
      const content = await fs.readFile(filePath, 'utf8');
      const data = JSON.parse(content);
      return data.stocks || [];
    } catch (error) {
      return [];
    }
  }

  /**
   * è¼‰å…¥ Digest CLI ç”¢å‡ºçš„æ‘˜è¦ï¼ˆbrief.mdï¼‰
   */
  async loadDigestBrief() {
    const digestPath = path.join(__dirname, "data/digest/output/brief.md");
    try {
      const md = await fs.readFile(digestPath, "utf8");
      return md.trim();
    } catch (e) {
      return "";
    }
  }



  /**
   * ç”Ÿæˆ Daily Snapshot
   */
  async generateDailySnapshot(news, marketData) {
    // æ ¹æ“šæ–°èèˆ‡å¸‚å ´æ•¸æ“šï¼Œæç…‰ 3-5 å€‹é—œéµé‡é»

    
    // æ ¹æ“šå¸‚å ´æ•¸æ“šç”Ÿæˆç¬¬ä¸€æ¢
    const twChange = marketData.twii.change;
    const spChange = marketData.sp500.change;
    
    if (Math.abs(twChange) > 1) {
      if (twChange < 0) {
        snapshot.push(`å°è‚¡é«˜æª”éœ‡ç›ªï¼ŒæŒ‡æ•¸å›æª” ${Math.abs(twChange).toFixed(2)}%`);
      } else {
        snapshot.push(`å°è‚¡çºŒå¼·ï¼ŒæŒ‡æ•¸ä¸Šæ¼² ${twChange.toFixed(2)}%`);
      }
    } else {
      snapshot.push('å°è‚¡ç›¤æ•´ï¼Œç­‰å¾…æ–¹å‘æ˜æœ—');
    }
    
    // å¾æ–°èä¸­æå–é—œéµäº‹ä»¶
    const macroNews = topNews.filter(n => n.analysis.category === 'ç¸½ç¶“');
    if (macroNews.length > 0) {
      const firstMacro = macroNews[0];
      const shortTitle = firstMacro.title.substring(0, 30);
      snapshot.push(`${shortTitle}ï¼Œ${firstMacro.analysis.marketImplication.substring(0, 20)}`);
    }
    
    // ç”¢æ¥­è¶¨å‹¢
    const industryNews = topNews.filter(n => n.analysis.category === 'ç”¢æ¥­' || n.analysis.category === 'å°è‚¡');
    if (industryNews.length > 0) {
      const industries = industryNews.slice(0, 2).map(n => {
        if (n.title.includes('AI') || n.title.includes('å°ç©é›»')) return 'AI æ—ç¾¤';
        if (n.title.includes('è¨˜æ†¶é«”')) return 'è¨˜æ†¶é«”æ—ç¾¤';
        if (n.title.includes('è˜‹æœ')) return 'è˜‹æœä¾›æ‡‰éˆ';
        return 'ç§‘æŠ€è‚¡';
      });
      snapshot.push(`${industries[0]}æŒçºŒå—é—œæ³¨`);
    }
    
    // åŒ¯ç‡
    if (Math.abs(marketData.usd_twd.change) > 0.5) {
      if (marketData.usd_twd.change > 0) {
        snapshot.push(`å°å¹£è²¶å€¼å£“åŠ›ï¼Œé—œæ³¨ ${marketData.usd_twd.value.toFixed(2)} é—œå¡`);
      } else {
        snapshot.push(`å°å¹£è½‰å¼·ï¼Œç¾å…ƒå›è½`);
      }
    }
    
    return snapshot.slice(0, 5);
  }

  /**
   * ç”Ÿæˆ Market Regime
   */
  async generateMarketRegime(news, marketData) {
    // åŸºæ–¼å¸‚å ´æ•¸æ“šèˆ‡æ–°èåˆ¤æ–· Regime
    const vixChange = marketData.vix.change;
    const twChange = marketData.twii.change;
    const spChange = marketData.sp500.change;
    
    let state = '';
    let flow = '';
    let implication = '';
    
    // åˆ¤æ–· Risk-on / Risk-off
    if (vixChange > 1) {
      state = 'Risk-off æƒ…ç·’å‡æº«ï¼Œå¸‚å ´é¿éšªéœ€æ±‚å¢åŠ ';
    } else if (vixChange < -1) {
      state = 'Risk-on ä¸»å°ï¼Œå¸‚å ´é¢¨éšªåå¥½å›å‡';
    } else {
      state = 'Risk-on èˆ‡ Risk-off ä¸¦å­˜';
    }
    
    // åˆ¤æ–·è³‡é‡‘æµå‘
    if (twChange > 0 && spChange > 0) {
      flow = 'å…¨çƒè‚¡å¸‚åŒæ­¥èµ°å¼·ï¼Œè³‡é‡‘åå¥½é¢¨éšªè³‡ç”¢';
    } else if (twChange < 0 && spChange < 0) {
      flow = 'å…¨çƒè‚¡å¸‚åŒæ­¥èµ°å¼±ï¼Œè³‡é‡‘è½‰å‘é˜²ç¦¦';
    } else if (Math.abs(twChange) > Math.abs(spChange)) {
      flow = 'è³‡é‡‘è¼ªå‹•åŠ é€Ÿï¼Œå°è‚¡æ³¢å‹•å¤§æ–¼ç¾è‚¡';
    } else {
      flow = 'è³‡é‡‘è¼ªå‹•åŠ é€Ÿï¼Œè¿½é€é¡Œææ˜ç¢ºæ¨™çš„';
    }
    
    // åˆ¤æ–· Market Implication
    const hasHighImportanceNews = news.filter(n => n.analysis.importance >= 9).length > 0;
    
    if (hasHighImportanceNews) {
      implication = 'é‡å¤§äº‹ä»¶ä¸»å°ï¼ŒçŸ­æœŸæ³¢å‹•åŠ åŠ‡';
    } else if (Math.abs(twChange) > 2) {
      implication = 'é«˜æª”éœ‡ç›ªï¼Œæ³¢æ®µæ“ä½œç‚ºä¸»';
    } else {
      implication = 'é¸è‚¡ä¸é¸å¸‚ï¼Œèšç„¦åŸºæœ¬é¢';
    }
    
    return { state, flow, implication };
  }

  /**
   * ç”Ÿæˆ Advisor Briefï¼ˆå®¢æˆ¶æºé€šé‡é»ï¼‰
   */
  async generateAdvisorBrief(news, marketData) {
    const twChange = marketData.twii.change;
    const topNews = news.slice(0, 5);
    
    // ä»Šæ—¥ä¸»è»¸
    let mainTheme = 'å¤–è³‡è³£å£“ + AI åˆ†åŒ–';
    if (topNews.length > 0) {
      const categories = topNews.map(n => n.analysis.category);
      if (categories.filter(c => c === 'ç¸½ç¶“').length > 2) {
        mainTheme = 'ç¸½ç¶“æ•¸æ“šä¸»å°';
      } else if (categories.filter(c => c === 'å°è‚¡').length > 2) {
        mainTheme = 'å°è‚¡çµæ§‹æ€§èª¿æ•´';
      }
    }
    
    // å®¢æˆ¶å¸¸å•
    let commonQuestion = 'å°ç©é›»é‚„èƒ½è²·å—ï¼Ÿ';
    const taiwanNews = topNews.filter(n => n.analysis.category === 'å°è‚¡');
    if (taiwanNews.length > 0 && taiwanNews[0].title.includes('è¯ç™¼ç§‘')) {
      commonQuestion = 'è¯ç™¼ç§‘æ³•èªªæœƒå¾Œæ€éº¼çœ‹ï¼Ÿ';
    }
    
    // æ¨™æº–ç­”è¦†
    let standardAnswer = '';
    if (twChange < -1.5) {
      standardAnswer = 'çŸ­ç·šéœ‡ç›ªåŠ åŠ‡ï¼Œé•·ç·šæŒæœ‰ç‚ºå®œï¼›å»ºè­°åˆ†æ‰¹ä½ˆå±€ï¼Œè¨­åœæ 31,500';
    } else if (twChange > 1.5) {
      standardAnswer = 'çŸ­ç·šè¶…æ¼²ï¼Œå»ºè­°é©åº¦ç²åˆ©äº†çµï¼›é•·ç·šæŒæœ‰è€…å¯çºŒæŠ±';
    } else {
      standardAnswer = 'ç›¤æ•´æ ¼å±€ï¼Œè§€æœ›ç‚ºä¸»ï¼›ç­‰å¾…æ˜ç¢ºè¨Šè™Ÿå†é€²å ´';
    }
    
    return { mainTheme, commonQuestion, standardAnswer };
  }

  /**
   * ç”Ÿæˆ Risk Dashboardï¼ˆé¢¨éšªå„€è¡¨æ¿ï¼‰
   */
  async generateRiskDashboard(news, marketData) {
    const twChange = marketData.twii.change;
    const vixChange = marketData.vix.change;
    
    // ç³»çµ±æ€§é¢¨éšª
    let systemicRisk = 'ä½';
    let systemicRiskEmoji = 'âœ…';
    if (Math.abs(twChange) > 2 || vixChange > 2) {
      systemicRisk = 'ä¸­é«˜';
      systemicRiskEmoji = 'âš ï¸';
    } else if (Math.abs(twChange) > 1 || vixChange > 1) {
      systemicRisk = 'ä¸­';
      systemicRiskEmoji = 'ğŸŸ¡';
    }
    
    // ç”¢æ¥­è¼ªå‹•
    let sectorRotation = 'å¹³ç©©';
    let sectorRotationEmoji = 'â¡ï¸';
    const industryNews = news.filter(n => n.analysis.category === 'ç”¢æ¥­').length;
    if (industryNews > 3) {
      sectorRotation = 'é€²è¡Œä¸­';
      sectorRotationEmoji = 'ğŸ”„';
    }
    
    // æ³¢å‹•å€é–“ï¼ˆç°¡åŒ–ç‰ˆï¼Œå¯¦éš›æ‡‰ä½¿ç”¨æŠ€è¡“åˆ†æï¼‰
    const twValue = marketData.twii.value;
    const support = Math.floor(twValue * 0.98 / 100) * 100;
    const resistance = Math.ceil(twValue * 1.02 / 100) * 100;
    const volatilityRange = `${support}-${resistance}`;
    
    return {
      systemicRisk,
      systemicRiskEmoji,
      sectorRotation,
      sectorRotationEmoji,
      volatilityRange
    };
  }

  /**
   * ç”Ÿæˆ Money Flowï¼ˆè³‡é‡‘æµå‘ï¼‰- ä½¿ç”¨çœŸå¯¦ä¸‰å¤§æ³•äººæ•¸æ“š
   */
  async generateMoneyFlow(news, marketData) {
    const twChange = marketData.twii.change;
    
    // æª¢æŸ¥æ˜¯å¦æœ‰çœŸå¯¦ä¸‰å¤§æ³•äººæ•¸æ“š
    if (marketData.institutional_investors && marketData.institutional_investors.hasData) {
      const instData = marketData.institutional_investors;
      const historyData = marketData.institutional_investors_history || [];
      
      // è¨ˆç®—ç´¯ç©è²·è³£è¶…ï¼ˆæœ€è¿‘ N å€‹äº¤æ˜“æ—¥ï¼‰
      const foreignTotal = historyData.reduce((sum, day) => sum + (day.foreign?.net || 0), 0);
      const foreignDays = historyData.length;
      const foreignTrend = foreignDays > 0 
        ? `é€£çºŒ ${foreignDays} æ—¥ï¼Œç´¯è¨ˆ ${foreignTotal > 0 ? '+' : ''}${foreignTotal.toFixed(0)} å„„` 
        : instData.foreign.trend;
      
      // æŠ•ä¿¡ç­–ç•¥åˆ†æ
      let trustFocus = 'ä½æª”æ‰¿æ¥é›»å­';
      if (instData.trust.net > 10) {
        trustFocus = 'ç©æ¥µè²·é€²ç§‘æŠ€';
      } else if (instData.trust.net < -10) {
        trustFocus = 'ç²åˆ©äº†çµ';
      } else if (Math.abs(instData.trust.net) < 5) {
        trustFocus = 'è§€æœ›';
      }
      
      // è‡ªç‡Ÿå•†ç­–ç•¥
      let dealerStrategy = 'é¿éšª';
      if (instData.dealer.net > 10) {
        dealerStrategy = 'åå¤š';
      } else if (instData.dealer.net < -10) {
        dealerStrategy = 'åç©º';
      }
      
      // æ•£æˆ¶æƒ…ç·’ï¼ˆåŸºæ–¼å¸‚å ´è®ŠåŒ–èˆ‡ä¸‰å¤§æ³•äººå‹•å‘åæ¨ï¼‰
      let retailSentiment = 50;  // ä¸­æ€§
      
      // å¤–è³‡å¤§å¹…è³£è¶… + å¸‚å ´ä¸‹è·Œ â†’ æ•£æˆ¶ææ…Œ
      if (instData.foreign.net < -100 && twChange < -1) {
        retailSentiment = 70;  // ææ…Œ
      } 
      // å¤–è³‡è²·è¶… + å¸‚å ´ä¸Šæ¼² â†’ æ•£æˆ¶æ¨‚è§€
      else if (instData.foreign.net > 50 && twChange > 1) {
        retailSentiment = 30;  // æ¨‚è§€ï¼ˆæ•¸å­—è¶Šä½è¶Šæ¨‚è§€ï¼‰
      }
      // ä¸‰å¤§æ³•äººåŒæ­¥è²·è¶…ä½†å¸‚å ´ä¸‹è·Œ â†’ æ•£æˆ¶ææ…Œæ€§è³£å‡º
      else if (instData.total.net > 50 && twChange < -0.5) {
        retailSentiment = 75;
      }
      // å¸‚å ´éœ‡ç›ª
      else if (Math.abs(twChange) < 0.5) {
        retailSentiment = 50;
      } else {
        retailSentiment = 50 + (twChange * -10);  // è·Œè¶Šå¤šè¶Šææ…Œ
      }
      
      return {
        foreign: {
          amount: instData.foreign.netAmount,
          trend: foreignTrend
        },
        trust: {
          amount: instData.trust.netAmount,
          focus: trustFocus
        },
        dealer: {
          amount: instData.dealer.netAmount,
          strategy: dealerStrategy
        },
        retail: {
          sentiment: Math.round(Math.max(0, Math.min(100, retailSentiment))),
          sentimentMax: 100
        },
        hasRealData: true
      };
    }
    
    // è‹¥ç„¡çœŸå¯¦æ•¸æ“šï¼Œä½¿ç”¨é è¨­å€¼ï¼ˆå‘ä¸‹ç›¸å®¹ï¼‰
    console.warn('[Money Flow] ç„¡ä¸‰å¤§æ³•äººæ•¸æ“šï¼Œä½¿ç”¨é è¨­å€¼');
    return {
      foreign: {
        amount: twChange < 0 ? 'è³£è¶… 120 å„„' : 'è²·è¶… 80 å„„',
        trend: twChange < 0 ? 'é€£çºŒ 3 æ—¥ï¼Œç´¯è¨ˆ -380 å„„' : 'é€£çºŒ 2 æ—¥ï¼Œç´¯è¨ˆ +150 å„„'
      },
      trust: {
        amount: 'è²·è¶… 8 å„„',
        focus: 'ä½æª”æ‰¿æ¥é›»å­'
      },
      dealer: {
        amount: twChange < 0 ? 'è³£è¶… 15 å„„' : 'è²·è¶… 10 å„„',
        strategy: twChange < 0 ? 'é¿éšª' : 'åå¤š'
      },
      retail: {
        sentiment: Math.abs(twChange) > 1.5 ? 65 : 45,
        sentimentMax: 100
      },
      hasRealData: false
    };
  }

  /**
   * ç”Ÿæˆ Sector Rotationï¼ˆç”¢æ¥­è¼ªå‹•åœ°åœ–ï¼‰
   */
  async generateSectorRotation(news, marketData) {
    // åŸºæ–¼æ–°èèˆ‡å¸‚å ´æ•¸æ“šåˆ¤æ–·ç”¢æ¥­è¼ªå‹•
    const industryNews = news.filter(n => n.analysis.category === 'ç”¢æ¥­' || n.analysis.category === 'å°è‚¡');
    
    // ç°¡åŒ–ç‰ˆæœ¬ï¼šæ ¹æ“šæ–°èæƒ…ç·’èˆ‡å¸‚å ´è®ŠåŒ–
    let inflow = [];
    let outflow = [];
    let watchTargets = [];
    
    if (marketData.twii.change < -1) {
      // ä¸‹è·Œæ™‚ï¼Œé˜²ç¦¦æ€§ç”¢æ¥­å¯èƒ½æœ‰è³‡é‡‘æµå…¥
      inflow = ['é‡‘è (+8%)', 'å‚³ç”¢ (+5%)'];
      outflow = ['AI (-12%)', 'åŠå°é«” (-9%)'];
      watchTargets = ['2884 ç‰å±±é‡‘', '2002 ä¸­é‹¼'];
    } else if (marketData.twii.change > 1) {
      // ä¸Šæ¼²æ™‚ï¼Œæˆé•·æ€§ç”¢æ¥­å¯èƒ½æœ‰è³‡é‡‘æµå…¥
      inflow = ['AI (+15%)', 'åŠå°é«” (+10%)'];
      outflow = ['é‡‘è (-3%)', 'å‚³ç”¢ (-2%)'];
      watchTargets = ['2330 å°ç©é›»', '2454 è¯ç™¼ç§‘'];
    } else {
      // ç›¤æ•´æ™‚
      inflow = ['è¨˜æ†¶é«” (+5%)', 'é›»å‹•è»Š (+3%)'];
      outflow = ['èˆªé‹ (-2%)', 'ç‡Ÿå»º (-1%)'];
      watchTargets = ['2408 å—äºç§‘', '2603 é•·æ¦®'];
    }
    
    // å¾æ–°èä¸­æå–å¯¦éš›è¼ªå‹•ç·šç´¢
    const aiNews = industryNews.filter(n => 
      n.title.includes('AI') || n.title.includes('å°ç©é›»') || n.title.includes('è¼é”')
    );
    if (aiNews.length > 2 && marketData.twii.change < 0) {
      outflow[0] = 'AI (-12%)';
    }
    
    return { inflow, outflow, watchTargets };
  }

  /**
   * ç”Ÿæˆ Macro Policyï¼ˆæ·±åŒ–ç‰ˆï¼‰
   */
  async generateMacroPolicy(news, marketData) {
    const macroNews = news.filter(n => n.analysis.category === 'ç¸½ç¶“');
    
    // Fed æ…‹åº¦
    let fedAttitude = 'é´¿æ´¾ï¼ˆé™æ¯é æœŸå‡æº«ï¼‰';
    if (marketData.us10y.change > 0.1) {
      fedAttitude = 'é·¹æ´¾ï¼ˆå‡æ¯é æœŸå‡æº«ï¼‰';
    } else if (Math.abs(marketData.us10y.change) < 0.05) {
      fedAttitude = 'ä¸­æ€§ï¼ˆæ”¿ç­–ç¶­æŒä¸è®Šï¼‰';
    }
    
    // å°å°è‚¡å½±éŸ¿
    let taiwanImpact = 'âœ… åˆ©å¤šï¼ˆè³‡é‡‘å›æµæ–°èˆˆå¸‚å ´ï¼‰';
    let taiwanImpactType = 'positive';
    if (marketData.dxy.change > 0.5) {
      taiwanImpact = 'âŒ åˆ©ç©ºï¼ˆè³‡é‡‘å›æµç¾å…ƒï¼‰';
      taiwanImpactType = 'negative';
    } else if (Math.abs(marketData.dxy.change) < 0.3) {
      taiwanImpact = 'âš–ï¸ ä¸­æ€§ï¼ˆå½±éŸ¿æœ‰é™ï¼‰';
      taiwanImpactType = 'neutral';
    }
    
    // é—œéµæ™‚é»
    let keyTimeline = '2/7 éè¾²æ•¸æ“šï¼ˆè‹¥å„ªæ–¼é æœŸï¼Œé™æ¯é æœŸé™æº«ï¼‰';
    const upcomingEvents = news.filter(n => 
      n.title.includes('æ•¸æ“š') || n.title.includes('CPI') || n.title.includes('éè¾²') || n.title.includes('å¤±æ¥­ç‡')
    );
    if (upcomingEvents.length > 0) {
      const event = upcomingEvents[0].title;
      keyTimeline = `${event}ï¼ˆé—œæ³¨å°å¸‚å ´æƒ…ç·’å½±éŸ¿ï¼‰`;
    }
    
    return {
      keyData: {
        us10y: `${marketData.us10y.value.toFixed(2)}% (${marketData.us10y.change > 0 ? 'â–²' : 'â–¼'}${Math.abs(marketData.us10y.change).toFixed(2)})`,
        dxy: `${marketData.dxy.value.toFixed(2)} (${marketData.dxy.change > 0 ? 'â–²' : 'â–¼'}${Math.abs(marketData.dxy.change).toFixed(1)}%)`,
        fedFunds: '3.5%-3.75%',
        vix: `${marketData.vix.value.toFixed(2)} (${marketData.vix.change > 0 ? 'â–²' : 'â–¼'}${Math.abs(marketData.vix.change).toFixed(1)})`
      },
      fedAttitude,
      taiwanImpact,
      taiwanImpactType,
      keyTimeline
    };
  }

  /**
   * ç”Ÿæˆ Geopoliticsï¼ˆåƒ…é‡å¤§äº‹ä»¶æ™‚å±•é–‹ï¼‰
   */
  async generateGeopolitics(news) {
    const geoNews = news.filter(n => 
      (n.title.toLowerCase().includes('iran') ||
       n.title.toLowerCase().includes('china') ||
       n.title.toLowerCase().includes('russia') ||
       n.title.toLowerCase().includes('taiwan') ||
       n.title.toLowerCase().includes('æˆ°çˆ­') ||
       n.title.toLowerCase().includes('è»äº‹') ||
       n.title.toLowerCase().includes('åˆ¶è£')) &&
      n.analysis.importance >= 8  // åƒ…é‡è¦æ–°è
    );

    // ç„¡é‡å¤§åœ°ç·£äº‹ä»¶ï¼šåƒ…ä¿ç•™ä¸€è¡Œ
    if (geoNews.length === 0) {
      return {
        hasMajorEvent: false,
        summary: 'åœ°ç·£æ”¿æ²»é¢¨éšªæš«æ™‚é™æº«',
        implication: 'é—œæ³¨é‡å¿ƒå›æ­¸åŸºæœ¬é¢'
      };
    }

    // æœ‰é‡å¤§äº‹ä»¶ï¼šå±•é–‹è©³ç´°å…§å®¹
    return {
      hasMajorEvent: true,
      events: geoNews.slice(0, 3).map(n => n.title),
      implication: geoNews[0].analysis.marketImplication
    };
  }

  /**
   * ç”Ÿæˆ Structural Theme
   */
  async generateStructuralTheme(news) {
    const aiNews = news.filter(n => 
      n.title.toLowerCase().includes('ai') ||
      n.title.toLowerCase().includes('nvidia') ||
      n.title.toLowerCase().includes('openai')
    );

    if (aiNews.length === 0) {
      return null;
    }

    return {
      theme: 'AI_CapEx_vs_Monetization',
      description: 'å¸‚å ´æŒçºŒé—œæ³¨ AI æŠ•è³‡å›æ”¶æœŸ',
      divergence: ['é›²ç«¯æˆé•·æ”¾ç·© vs ç®—åŠ›éœ€æ±‚ä»å¼·', 'è»Ÿé«”è®Šç¾ä¸å¦‚é æœŸ vs ç¡¬é«”è¨‚å–®æš¢æ—º'],
      implication: 'AI ç”¢æ¥­éˆåˆ†åŒ–ï¼Œèšç„¦å·²æœ‰ç²åˆ©æ”¹å–„è€…'
    };
  }

  /**
   * ç”Ÿæˆ Equity Market
   */
  async generateEquityMarket(news) {
    const equityNews = news.filter(n => 
      n.analysis.category === 'å°è‚¡' || n.analysis.category === 'ç¾è‚¡'
    );

    // ç°¡åŒ–ç‰ˆæœ¬ï¼Œæ ¹æ“šæ–°èåˆ†é¡
    const winners = equityNews
      .filter(n => n.title.includes('æ¼²') || n.title.includes('å¼·å‹') || n.title.includes('ä¸Šæ¼²'))
      .slice(0, 3);
    
    const losers = equityNews
      .filter(n => n.title.includes('è·Œ') || n.title.includes('ç–²å¼±') || n.title.includes('ä¸‹è·Œ'))
      .slice(0, 3);

    return {
      winners: winners.map(n => n.title),
      losers: losers.map(n => n.title),
      divergence: ['åŠå°é«”å…§éƒ¨è¼ªå‹•', 'AI ç”¢æ¥­éˆåˆ†åŒ–', 'å‚³ç”¢ vs ç§‘æŠ€']
    };
  }

  /**
   * ç”Ÿæˆ Cross Assetï¼ˆç²¾ç°¡ç‚ºé—œéµè®Šæ•¸ï¼‰
   */
  async generateCrossAsset(news, marketData) {
    // é—œéµè®Šæ•¸ 1ï¼šç¾å…ƒ â†’ å°å¹£ â†’ å‡ºå£è‚¡
    let keyVar1 = '';
    if (marketData.dxy.change < -0.3) {
      keyVar1 = 'ğŸ”‘ ç¾å…ƒèµ°å¼± â†’ å°å¹£å‡å€¼å£“åŠ› â†’ å‡ºå£è‚¡åˆ©ç©º';
    } else if (marketData.dxy.change > 0.3) {
      keyVar1 = 'ğŸ”‘ ç¾å…ƒèµ°å¼· â†’ å°å¹£è²¶å€¼ â†’ å‡ºå£è‚¡åˆ©å¤š';
    } else {
      keyVar1 = 'ğŸ”‘ ç¾å…ƒæŒå¹³ â†’ åŒ¯ç‡å½±éŸ¿æœ‰é™';
    }
    
    // é—œéµè®Šæ•¸ 2ï¼šé¿éšªéœ€æ±‚ â†’ é»ƒé‡‘ â†’ é¢¨éšªåå¥½
    let keyVar2 = '';
    if (marketData.vix.change > 1) {
      keyVar2 = 'ğŸ”‘ é¿éšªéœ€æ±‚å‡æº« â†’ é»ƒé‡‘ä¸Šæ¼² â†’ é¢¨éšªåå¥½ä¸‹é™';
    } else if (marketData.vix.change < -1) {
      keyVar2 = 'ğŸ”‘ é¿éšªéœ€æ±‚é™æº« â†’ é»ƒé‡‘å›è½ â†’ é¢¨éšªåå¥½å›å‡';
    } else {
      keyVar2 = 'ğŸ”‘ é¿éšªæƒ…ç·’å¹³ç©© â†’ é»ƒé‡‘æŒç©©';
    }
    
    // é—œéµè®Šæ•¸ 3ï¼šåŸæ²¹ï¼ˆå½±éŸ¿é€šè†¨é æœŸï¼‰
    let keyVar3 = 'ğŸ”‘ åŸæ²¹æŒå¹³ â†’ é€šè†¨é æœŸç©©å®š';
    
    // ç°¡åŒ–æ•¸æ“š
    const simplifiedData = {
      usd: `ç¾å…ƒ ${marketData.dxy.value.toFixed(2)} (${marketData.dxy.change > 0 ? 'â–²' : 'â–¼'}${Math.abs(marketData.dxy.change).toFixed(1)}%)`,
      gold: marketData.vix.change > 1 ? 'é»ƒé‡‘ â–² (é¿éšª)' : 'é»ƒé‡‘ â¡ï¸',
      oil: 'åŸæ²¹ â¡ï¸'
    };
    
    return {
      keyVariables: [keyVar1, keyVar2, keyVar3],
      simplifiedData
    };
  }

  /**
   * ç”Ÿæˆ Taiwan Market
   */
  async generateTaiwanMarket(news, marketData) {
    const taiwanNews = news.filter(n => n.analysis.category === 'å°è‚¡');
    
    return {
      index: `åŠ æ¬ŠæŒ‡æ•¸ ${marketData.twii.value.toFixed(0)} ${marketData.twii.change > 0 ? 'â–²' : 'â–¼'}${Math.abs(marketData.twii.change).toFixed(2)}%`,
      volume: 'æˆäº¤é‡ 4,850 å„„', // TODO: å¯¦éš›æ•¸æ“š
      foreign: 'å¤–è³‡è³£è¶… 120 å„„', // TODO: å¯¦éš›æ•¸æ“š
      trend: taiwanNews.length > 0 ? taiwanNews[0].title : 'æ¬Šå€¼è‚¡æ‹‰å›',
      implication: 'é«˜æª”éœ‡ç›ªï¼Œé¸è‚¡é‡æ–¼é¸å¸‚'
    };
  }

  /**
   * ç”Ÿæˆ Watchlist Focus
   */
  async generateWatchlistFocus(news, watchlist) {
    if (watchlist.length === 0) {
      return {};
    }

    const watchlistNews = {};
    
    for (const stock of watchlist) {
      const { code, name } = stock;
      
      // æœå°‹ç›¸é—œæ–°èï¼ˆä½¿ç”¨è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±ï¼‰
      const relatedNews = news.filter(n => 
        n.title.includes(code) || 
        n.title.includes(name) ||
        (n.analysis.affectedAssets && (
          n.analysis.affectedAssets.includes(code) ||
          n.analysis.affectedAssets.includes(name)
        ))
      );
      
      if (relatedNews.length > 0) {
        watchlistNews[`${code} ${name}`] = relatedNews;
      }
    }

    return watchlistNews;
  }

  /**
   * ç”Ÿæˆ Event Calendarï¼ˆæ¨™è¨»å½±éŸ¿ç¨‹åº¦ï¼‰
   */
  async generateEventCalendar(news) {
    const eventNews = news.filter(n => {
      const title = n.title;
      // æ’é™¤ç ”ç©¶å ±å‘Šã€æ™¨é–“å ±å‘Šç­‰éäº‹ä»¶é¡æ–°è
      if (title.includes('ç ”ç©¶å ±å‘Š') || title.includes('æ™¨é–“') || title.includes('ç›¤å‰')) {
        return false;
      }
      // åªä¿ç•™çœŸæ­£çš„äº‹ä»¶ï¼šæ³•èªªæœƒã€è²¡å ±ã€ç¶“æ¿Ÿæ•¸æ“š
      return (
        n.analysis.category === 'æ³•èªªæœƒ' ||
        title.includes('æ³•èªªæœƒ') ||
        title.includes('è²¡å ±') ||
        (title.includes('æ•¸æ“š') && !title.includes('é—œæ³¨')) ||
        (title.includes('å…¬å¸ƒ') && (title.includes('GDP') || title.includes('CPI') || title.includes('å°±æ¥­')))
      );
    });

    // é è¨­äº‹ä»¶ï¼ˆå¸¶å½±éŸ¿ç¨‹åº¦æ¨™è¨»ï¼‰
    const defaultEvents = [
      { impact: 'high', text: '2/7ï¼ˆäº”ï¼‰ç¾åœ‹ 1æœˆå°±æ¥­å ±å‘Š', note: 'é æœŸ +18 è¬' },
      { impact: 'medium', text: '2/5ï¼ˆä¸‰ï¼‰è¯ç™¼ç§‘æ³•èªªæœƒ', note: '' },
      { impact: 'low', text: '2/6ï¼ˆå››ï¼‰ç¾åœ‹åˆé ˜å¤±æ¥­é‡‘', note: '' }
    ];
    
    // å¾æ–°èä¸­æå–å¯¦éš›äº‹ä»¶
    const extractedEvents = eventNews.slice(0, 5).map(n => {
      let impact = 'medium';
      if (n.analysis.importance >= 9) {
        impact = 'high';
      } else if (n.analysis.importance < 7) {
        impact = 'low';
      }
      
      return {
        impact,
        text: n.title.substring(0, 50),
        note: n.analysis.marketImplication.substring(0, 30)
      };
    });
    
    // åˆä½µä¸¦æ’åºï¼ˆé«˜å½±éŸ¿ â†’ ä¸­å½±éŸ¿ â†’ ä½å½±éŸ¿ï¼‰
    const allEvents = [...extractedEvents, ...defaultEvents];
    const uniqueEvents = allEvents.filter((event, index, self) =>
      index === self.findIndex(e => e.text === event.text)
    );
    
    return uniqueEvents.sort((a, b) => {
      const order = { high: 0, medium: 1, low: 2 };
      return order[a.impact] - order[b.impact];
    }).slice(0, 5);
  }

  /**
   * çµ„è£å®Œæ•´å ±å‘Šï¼ˆæ›´æ–°ç‰ˆï¼‰
   */
  assembleBrief(sections) {
    // æª¢æŸ¥ä¸¦æ¨™ç¤ºæ•¸æ“šç‹€æ…‹
    let dataStatus = '';
    
    // å„ªå…ˆé¡¯ç¤ºæ™‚é–“ç‹€æ…‹ï¼ˆç›¤ä¸­å ±å‘Šï¼‰
    if (this.dataStatusMessage) {
      dataStatus = ` ${this.dataStatusMessage}`;
    } 
    // å…¶æ¬¡é¡¯ç¤ºæ•¸æ“šç‹€æ…‹ï¼ˆéäº¤æ˜“æ—¥/ä¼°ç®—å€¼ï¼‰
    else if (!sections.moneyFlow.hasRealData) {
      dataStatus = ` âš ï¸ éäº¤æ˜“æ—¥ï¼ˆä½¿ç”¨ä¼°ç®—å€¼ï¼‰`;
    }
    
    let brief = `ğŸ“Œ Daily_Market_Briefï½œ${this.date}${dataStatus}\nâ¸»\n\n`;

    // 1. Advisor Briefï¼ˆå®¢æˆ¶æºé€šé‡é»ï¼‰
    brief += `ğŸ’¼ Advisor_Briefï¼ˆ30 ç§’é‡é»ï¼‰\n`;
    brief += `â€¢ ä»Šæ—¥ä¸»è»¸ï¼š${sections.advisorBrief.mainTheme}\n`;
    brief += `â€¢ å®¢æˆ¶å¸¸å•ï¼šã€Œ${sections.advisorBrief.commonQuestion}ã€\n`;
    brief += `â€¢ æ¨™æº–ç­”è¦†ï¼šã€Œ${sections.advisorBrief.standardAnswer}ã€\n`;
    brief += `\nâ¸»\n\n`;

    // 2. Risk Dashboardï¼ˆé¢¨éšªå„€è¡¨æ¿ï¼‰
    brief += `ğŸ¯ Risk_Dashboard\n`;
    brief += `â€¢ ç³»çµ±æ€§é¢¨éšªï¼š${sections.riskDashboard.systemicRiskEmoji} ${sections.riskDashboard.systemicRisk}`;
    if (sections.riskDashboard.systemicRisk !== 'ä½') {
      brief += `ï¼ˆå¤–è³‡è³£è¶… + æŒ‡æ•¸å›æª”ï¼‰`;
    }
    brief += `\n`;
    brief += `â€¢ ç”¢æ¥­è¼ªå‹•ï¼š${sections.riskDashboard.sectorRotationEmoji} ${sections.riskDashboard.sectorRotation}\n`;
    brief += `â€¢ æ³¢å‹•å€é–“ï¼š${sections.riskDashboard.volatilityRange}ï¼ˆçŸ­ç·šæ”¯æ’/å£“åŠ›ï¼‰\n`;
    brief += `\nâ¸»\n\n`;

    // 3. Daily Snapshot
    brief += `ğŸ”¹ Daily_Snapshot\n`;
    sections.dailySnapshot.forEach(point => {
      brief += `â€¢ ${point}\n`;
    });
    brief += `\nâ¸»\n\n`;

    // 4. Money Flowï¼ˆè³‡é‡‘æµå‘ï¼‰
    brief += `ğŸ’° Money_Flow\n`;
    brief += `â€¢ å¤–è³‡ï¼š${sections.moneyFlow.foreign.amount}ï¼ˆ${sections.moneyFlow.foreign.trend}ï¼‰\n`;
    brief += `â€¢ æŠ•ä¿¡ï¼š${sections.moneyFlow.trust.amount}ï¼ˆ${sections.moneyFlow.trust.focus}ï¼‰\n`;
    brief += `â€¢ è‡ªç‡Ÿå•†ï¼š${sections.moneyFlow.dealer.amount}ï¼ˆ${sections.moneyFlow.dealer.strategy}ï¼‰\n`;
    brief += `â€¢ æ•£æˆ¶æƒ…ç·’ï¼š${sections.moneyFlow.retail.sentiment}/${sections.moneyFlow.retail.sentimentMax}\n`;
    
    // æ¨™ç¤ºæ•¸æ“šä¾†æº
    if (!sections.moneyFlow.hasRealData) {
      brief += `\nâš ï¸  è¨»ï¼šç•¶æ—¥ç„¡äº¤æ˜“æ•¸æ“šï¼Œä½¿ç”¨ä¼°ç®—å€¼\n`;
    }
    
    brief += `\nâ¸»\n\n`;

    // 5. Market Regime
    brief += `ğŸ”¹ Market_Regime\n`;
    brief += `â€¢ ${sections.marketRegime.state}\n`;
    brief += `â€¢ ${sections.marketRegime.flow}\n`;
    brief += `\nğŸ“Š ${sections.marketRegime.implication}\n`;
    brief += `\nâ¸»\n\n`;

    // 6. Taiwan Market
    brief += `ğŸ”¹ Taiwan_Market\n`;
    brief += `â€¢ ${sections.taiwanMarket.index}\n`;
    brief += `â€¢ ${sections.taiwanMarket.volume}\n`;
    brief += `â€¢ ${sections.taiwanMarket.foreign}\n`;
    brief += `\nğŸ“Š ${sections.taiwanMarket.implication}\n`;
    // åŠ å…¥æ•¸æ“šæ—¥æœŸï¼ˆéä¾µå…¥å¼ï¼‰
    const dataDate = this.effectiveDate || this.date;
    brief += `\n_æ•¸æ“šæ—¥æœŸï¼š${dataDate}_\n`;
    brief += `\nâ¸»\n\n`;

    // 7. Sector Rotationï¼ˆç”¢æ¥­è¼ªå‹•åœ°åœ–ï¼‰
    brief += `ğŸ”„ Sector_Rotation\n`;
    brief += `â€¢ è³‡é‡‘æµå…¥ï¼š${sections.sectorRotation.inflow.map(s => `âœ… ${s}`).join('ã€')}\n`;
    brief += `â€¢ è³‡é‡‘æµå‡ºï¼š${sections.sectorRotation.outflow.map(s => `âŒ ${s}`).join('ã€')}\n`;
    brief += `â€¢ è§€å¯Ÿæ¨™çš„ï¼š${sections.sectorRotation.watchTargets.join('ã€')}\n`;
    brief += `\nâ¸»\n\n`;

    // 8. Macro Policyï¼ˆæ·±åŒ–ç‰ˆï¼‰
    brief += `ğŸ”¹ Macro_Policy\n\n`;
    brief += `Key_Data\n`;
    brief += `â€¢ US 10Y: ${sections.macroPolicy.keyData.us10y}\n`;
    brief += `â€¢ DXY: ${sections.macroPolicy.keyData.dxy}\n`;
    brief += `â€¢ Fed Funds Rate: ${sections.macroPolicy.keyData.fedFunds}\n`;
    brief += `â€¢ VIX: ${sections.macroPolicy.keyData.vix}\n`;
    brief += `\n`;
    brief += `â€¢ Fed æ…‹åº¦ï¼š${sections.macroPolicy.fedAttitude}\n`;
    brief += `â€¢ å°å°è‚¡å½±éŸ¿ï¼š${sections.macroPolicy.taiwanImpact}\n`;
    brief += `â€¢ é—œéµæ™‚é»ï¼š${sections.macroPolicy.keyTimeline}\n`;
    // åŠ å…¥æ•¸æ“šæ—¥æœŸï¼ˆéä¾µå…¥å¼ï¼‰
    brief += `\n_æ•¸æ“šæ›´æ–°ï¼šç¾è‚¡æ”¶ç›¤ ${this.effectiveDate || this.date}_\n`;
    brief += `\nâ¸»\n\n`;

    // 9. Geopoliticsï¼ˆåƒ…é‡å¤§äº‹ä»¶æ™‚å±•é–‹ï¼‰
    brief += `ğŸ”¹ Geopolitics\n`;
    if (sections.geopolitics.hasMajorEvent) {
      sections.geopolitics.events.forEach(event => {
        brief += `â€¢ ${event}\n`;
      });
      brief += `\nğŸ“Š ${sections.geopolitics.implication}\n`;
    } else {
      brief += `â€¢ ${sections.geopolitics.summary}\n`;
    }
    brief += `\nâ¸»\n\n`;

    // 10. Structural Theme (å¦‚æœæœ‰)
    if (sections.structuralTheme) {
      brief += `ğŸ”¹ Structural_Themeï½œ${sections.structuralTheme.theme}\n`;
      brief += `â€¢ ${sections.structuralTheme.description}\n`;
      brief += `â€¢ åˆ†æ­§ä¾†æºï¼š\n`;
      sections.structuralTheme.divergence.forEach(div => {
        brief += `  â€¢ ${div}\n`;
      });
      brief += `\nğŸ“Š ${sections.structuralTheme.implication}\n`;
      brief += `\nâ¸»\n\n`;
    }

    // 11. Cross Assetï¼ˆç²¾ç°¡ç‰ˆï¼‰
    brief += `ğŸ”¹ Cross_Asset\n`;
    sections.crossAsset.keyVariables.forEach(keyVar => {
      brief += `${keyVar}\n`;
    });
    brief += `\nç°¡åŒ–æ•¸æ“šï¼š\n`;
    brief += `â€¢ ${sections.crossAsset.simplifiedData.usd}\n`;
    brief += `â€¢ ${sections.crossAsset.simplifiedData.gold}\n`;
    brief += `â€¢ ${sections.crossAsset.simplifiedData.oil}\n`;
    brief += `\nâ¸»\n\n`;

    // 12. Watchlist Focus
    if (Object.keys(sections.watchlistFocus).length > 0) {
      brief += `ğŸ”¹ Watchlist_Focusï¼ˆ${Object.keys(sections.watchlistFocus).length} æª”æœ‰æ¶ˆæ¯ï¼‰\n\n`;
      Object.entries(sections.watchlistFocus).forEach(([symbol, newsItems]) => {
        brief += `${symbol}\n`;
        newsItems.slice(0, 2).forEach(n => {
          brief += `â€¢ ${n.title}\n`;
        });
        if (newsItems.length > 0) {
          brief += `\nğŸ“Š ${newsItems[0].analysis.marketImplication}\n`;
        }
        brief += `\n`;
      });
      brief += `â¸»\n\n`;
    }

    // 13. Event Calendarï¼ˆæ¨™è¨»å½±éŸ¿ç¨‹åº¦ï¼‰
    brief += `ğŸ”¹ Event_Calendar\n`;
    sections.eventCalendar.forEach(event => {
      const impactIcon = { high: 'ğŸ”´', medium: 'ğŸŸ¡', low: 'ğŸŸ¢' }[event.impact];
      brief += `â€¢ ${impactIcon} ${event.impact === 'high' ? 'é«˜å½±éŸ¿' : event.impact === 'medium' ? 'ä¸­å½±éŸ¿' : 'ä½å½±éŸ¿'}ï¼š${event.text}`;
      if (event.note) {
        brief += ` (${event.note})`;
      }
      brief += `\n`;
    });
    brief += `\nâ¸»\n\n`;

    // Disclaimer
    brief += `ğŸ”¹ Disclaimer\n`;
    brief += `â€¢ æœ¬å…§å®¹ç‚ºå¸‚å ´è³‡è¨Šå½™æ•´ï¼ŒéæŠ•è³‡å»ºè­°\n\n`;
    brief += `ğŸ”¹ Data_Source\n`;
    brief += `â€¢ Yahoo Finance / Reuters / å·¥å•†æ™‚å ± / ç¶“æ¿Ÿæ—¥å ±\n`;

    return brief;
  }

  /**
   * å‘¼å« AI
   */
  async callAI(prompt) {
    try {
      // ä½¿ç”¨ clawdbot sessions_send
      const { spawn } = require('child_process');
      
      return new Promise((resolve, reject) => {
        const clawdbot = spawn('clawdbot', ['sessions', 'send', '--message', prompt, '--timeout', '30']);
        
        let output = '';
        let errorOutput = '';
        
        clawdbot.stdout.on('data', (data) => {
          output += data.toString();
        });
        
        clawdbot.stderr.on('data', (data) => {
          errorOutput += data.toString();
        });
        
        clawdbot.on('close', (code) => {
          if (code === 0 && output.trim().length > 0) {
            // æå– AI å›æ‡‰ï¼ˆå»é™¤ç³»çµ±è¨Šæ¯ï¼‰
            const lines = output.split('\n');
            const aiResponse = lines
              .filter(line => {
                // éæ¿¾æ‰ debug è³‡è¨Š
                if (line.includes('[clawdbot]')) return false;
                if (line.includes('session:')) return false;
                if (line.includes('Session store:')) return false;
                if (line.includes('Sessions listed:')) return false;
                if (line.includes('Kind') && line.includes('Key')) return false;
                if (line.includes('direct') && line.includes('agent:main')) return false;
                if (line.includes('claude-sonnet')) return false;
                if (line.includes('Tokens')) return false;
                if (line.trim().startsWith('â€¢') && line.includes('ago')) return false;
                return true;
              })
              .join('\n')
              .trim();
            
            resolve(aiResponse || 'åˆ†æä¸­...');
          } else {
            console.error('[AI] å‘¼å«å¤±æ•—:', errorOutput);
            
            // å›å‚³é è¨­å€¼
            if (prompt.includes('Daily Snapshot')) {
              resolve(`â€¢ å°è‚¡é«˜æª”éœ‡ç›ªï¼Œæ¬Šå€¼è‚¡æ‹‰å›
â€¢ ç¾åœ‹éè¾²æ•¸æ“šä½æ–¼é æœŸï¼ŒFed é™æ¯é æœŸå‡æº«
â€¢ è¨˜æ†¶é«”æ—ç¾¤é€†å‹¢é ˜æ¼²
â€¢ å°å¹£è²¶å€¼å£“åŠ›æŒçºŒ`);
            } else if (prompt.includes('Market Regime')) {
              resolve(`ç‹€æ…‹ï¼šRisk-on èˆ‡ Risk-off ä¸¦å­˜
æµå‘ï¼šè³‡é‡‘è¼ªå‹•åŠ é€Ÿï¼Œè¿½é€é¡Œææ˜ç¢ºæ¨™çš„
æ„æ¶µï¼šé¸è‚¡ä¸é¸å¸‚ï¼Œèšç„¦åŸºæœ¬é¢`);
            } else {
              resolve('åˆ†æä¸­...');
            }
          }
        });
        
        setTimeout(() => {
          clawdbot.kill();
          reject(new Error('AI åˆ†æé€¾æ™‚'));
        }, 35000);
      });
    } catch (error) {
      console.error('[AI] å‘¼å«å¤±æ•—:', error.message);
      return 'åˆ†æä¸­...';
    }
  }

  /**
   * è§£æ Market Regime
   */
  parseMarketRegime(text) {
    const lines = text.split('\n').filter(l => l.trim());
    return {
      state: lines.find(l => l.includes('ç‹€æ…‹'))?.split('ï¼š')[1] || 'Risk-on èˆ‡ Risk-off ä¸¦å­˜',
      flow: lines.find(l => l.includes('æµå‘'))?.split('ï¼š')[1] || 'è³‡é‡‘è¼ªå‹•åŠ é€Ÿ',
      implication: lines.find(l => l.includes('æ„æ¶µ'))?.split('ï¼š')[1] || 'é¸è‚¡ä¸é¸å¸‚'
    };
  }

  /**
   * å„²å­˜ Daily Brief
   */
  async saveToFile(brief) {
    const outputPath = path.join(__dirname, 'data/daily-brief', `${this.date}.txt`);
    await fs.mkdir(path.dirname(outputPath), { recursive: true });
    await fs.writeFile(outputPath, brief, 'utf8');
    console.log(`ğŸ’¾ å·²å„²å­˜ Daily Brief åˆ°ï¼š${outputPath}`);
    return outputPath;
  }
}

// CLI ä½¿ç”¨
if (require.main === module) {
  (async () => {
    const generator = new DailyBriefGenerator();
    const brief = await generator.generate();
    
    if (brief) {
      await generator.saveToFile(brief);
      console.log('\n' + brief);
      console.log('\nâœ… Daily Brief ç”Ÿæˆå®Œæˆï¼');
    } else {
      console.log('âŒ Daily Brief ç”Ÿæˆå¤±æ•—');
      process.exit(1);
    }
  })();
}

module.exports = DailyBriefGenerator;
